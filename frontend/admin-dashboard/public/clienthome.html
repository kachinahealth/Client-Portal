<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KachinaHealth - Client Dashboard</title>
    <script>
        // API URL configuration for different environments
        window.API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000'
            : (window.location.protocol + '//' + window.location.hostname.replace('client', 'api') ||
               'https://your-backend-service.onrender.com');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 25%, #e0f2f1 50%, #f1f8e9 75%, #f9fbe7 100%);
            min-height: 100vh;
        }
        
        /* Add new style for centered dashboard title */
        .dashboard-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            text-align: center;
            flex: 1;                          /* take up remaining space */
        }
        
        /* Update header layout */
        .header {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 25%, #26a69a 50%, #66bb6a 75%, #9ccc65 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            min-height: 80px;
        }

        
        .logo {
            display: flex;
            align-items: center;
            background: #1e1e1e;
            padding: 0.75rem;
            border-radius: 15px;
            display: inline-block;
            width: fit-content;
        }
        
        .kachina-logo {
            width: 280px;
            height: auto;
            max-height: 80px;
            display: block;
            object-fit: contain;
            margin: 0;
        }
        
        /* Update company info layout */
        .company-info {
            display: flex;
            align-items: center;
            gap: 1rem;                        /* space between logout and logo */
        }
        
        /* Logo styles removed */
        
        .company-header {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
            border: 1px solid rgba(38, 166, 154, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(38, 166, 154, 0.15);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #1976d2, #26a69a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .tabs {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab-button {
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
            margin-right: 0.5rem;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
        }
        
        .tab-button.active {
            background: white;
            color: #1976d2;
            border-bottom-color: #26a69a;
            box-shadow: 0 -2px 10px rgba(38, 166, 154, 0.1);
        }
        
        .tab-content {
            padding: 2rem;
            display: none;
            background: white;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-top: -1px;
            border: 1px solid rgba(38, 166, 154, 0.1);
            border-top: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .user-table th,
        .user-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .user-table th {
            background: #f5f5f5;
            font-weight: 600;
        }
        
        .status-pending {
            color: #f57c00;
            font-weight: 500;
        }
        
        .status-approved {
            color: #388e3c;
            font-weight: 500;
        }
        
        .status-rejected {
            color: #d32f2f;
            font-weight: 500;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }
        
        .btn-approve {
            background: #4caf50;
            color: white;
        }
        
        .btn-reject {
            background: #f44336;
            color: white;
        }
        
        .news-form {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group-wide {
            flex: 2;
            margin-right: 1rem;
        }

        .form-group-narrow {
            flex: 1;
            margin-right: 1rem;
        }

        .form-group-narrow:last-child {
            margin-right: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .btn-primary {
            background: #1976d2;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .alert-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .alert-error {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }

        /* Content tabs for News & Updates */
        .content-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .content-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.3s;
        }
        
        .content-tab.active {
            color: #1976d2;
            border-bottom: 2px solid #1976d2;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }

        /* PDF Form Styles */
        .pdf-form {
            background: #f9f9f9;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .pdf-item {
            background: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border-left: 4px solid #1976d2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-info h5 {
            margin-bottom: 0.25rem;
        }

        .category-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }

        .pdf-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .pdf-info {
            flex: 1;
        }

        .pdf-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* PDF Viewer Modal Styles */
        .pdf-modal {
            max-width: 90vw;
            width: 1200px;
            height: 80vh;
        }

        .pdf-viewer-container {
            background: #f5f5f5;
            border-radius: 4px;
            padding: 1rem;
            height: 100%;
        }

        #pdfViewerFrame {
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
        }

        /* Basic Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .modal-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover,
        .close:focus {
            color: #000;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Leaderboard Styles */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-stat {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .summary-stat h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .form-row:not(:first-child) .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .materials-list {
            margin-top: 2rem;
        }

        .materials-list h4 {
            margin-bottom: 1rem;
            color: #333;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .leaderboard-table td:last-child {
            white-space: nowrap;
            min-width: 150px;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .leaderboard-table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e0e0e0); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #deb887); }

        .btn-view {
            background: #4caf50;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .btn-download {
            background: #ff9800;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .btn-edit {
            background: #2196f3;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .btn-delete {
            background: #f44336;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .editing-row {
            background-color: #e3f2fd !important;
            box-shadow: 0 0 10px rgba(25, 118, 210, 0.3);
        }

        .other-rows {
            opacity: 0.6;
        }

        /* Debug Panel Styles */
        .debug-panel {
            background: #f5f5f5;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .debug-panel h4 {
            margin-bottom: 1rem;
            color: #333;
        }

        .debug-panel pre {
            background: #333;
            color: #00ff00;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .debug-panel button {
            margin-right: 1rem;
            margin-bottom: 0.5rem;
        }

        #restoreForm {
            display: none;
            margin-top: 1rem;
        }

        #restoreForm textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 1rem;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .analytics-filters {
            margin-bottom: 2rem;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
        }

        .analytics-table-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow-x: auto;
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
        }

        .analytics-table th,
        .analytics-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .analytics-table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .user-analytics-chart {
            height: 300px;
            margin: 2rem 0;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Messaging Styles */
        .messaging-container {
            display: flex;
            height: calc(100vh - 200px);
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .messaging-sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .messaging-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messaging-header h4 {
            margin: 0;
            color: #333;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .conversation-item:hover {
            background: #e9ecef;
        }

        .conversation-item.active {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .conversation-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .conversation-preview {
            font-size: 0.875rem;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-time {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.25rem;
        }

        .messaging-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .message-thread {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .no-conversation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
        }

        .no-conversation-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .message {
            display: flex;
            margin-bottom: 1rem;
            max-width: 70%;
        }

        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            margin: 0 0.5rem;
        }

        .message-content {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            position: relative;
        }

        .message.sent .message-content {
            background: #2196f3;
            color: white;
        }

        .message-text {
            margin: 0;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.25rem;
        }

        .message.sent .message-time {
            color: rgba(255, 255, 255, 0.7);
            text-align: right;
        }

        .message-compose {
            border-top: 1px solid #e0e0e0;
            background: white;
            display: none;
        }

        .compose-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .compose-body {
            padding: 1rem;
        }

        .compose-body textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 1rem;
        }

        .compose-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .new-message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .new-message-modal {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            width: 400px;
            max-width: 90vw;
        }

        .new-message-modal h3 {
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .new-message-modal input,
        .new-message-modal textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .status-approved {
            background-color: #28a745;
            color: white;
        }

        .status-pending {
            background-color: #ffc107;
            color: #212529;
        }

        .status-revoked {
            background-color: #dc3545;
            color: white;
        }

        /* File Upload Styles */
        .file-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background-color: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .file-upload-area:hover {
            border-color: #1976d2;
            background-color: #f0f8ff;
        }

        .file-upload-area.dragover {
            border-color: #1976d2;
            background-color: #e3f2fd;
            transform: scale(1.02);
        }

        .file-upload-area.dragover .upload-icon {
            transform: scale(1.1);
        }

        .file-upload-content {
            pointer-events: none;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .upload-text {
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .upload-text strong {
            color: #334155;
            font-size: 1.1rem;
        }

        .upload-link {
            color: #1976d2;
            text-decoration: underline;
            cursor: pointer;
        }

        .upload-hint {
            color: #94a3b8;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .selected-file {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 4px;
            color: #2e7d32;
            font-weight: 500;
        }

        .selected-file::before {
            content: "âœ“ ";
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="logos/logo.png" alt="KachinaHealth Logo" class="kachina-logo">
        </div>
        
        <h1 class="dashboard-title">App Dashboard</h1>


        <div class="company-info">
            <button onclick="logout()" class="logout-button">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">-</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingApprovals">-</div>
                <div class="stat-label">Pending Approvals</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeUsers">-</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newsItems">-</div>
                <div class="stat-label">News Items</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab(0)">User Management</button>
                <button class="tab-button" onclick="showTab(1)">News & Updates</button>
                <button class="tab-button" onclick="showTab(2)">Enrollment Leaderboard</button>
                <button class="tab-button" onclick="showTab(3)">Clinical Trials</button>
                <button class="tab-button" onclick="showTab(4)">Training Materials</button>
                <button class="tab-button" onclick="showTab(5)">Study Protocol</button>
                <button class="tab-button" onclick="showTab(6)">Analytics</button>
                <button class="tab-button" onclick="showTab(7)">Messaging</button>
                <button class="tab-button" onclick="showTab(8)">Settings</button>
            </div>

            <div class="tab-content active" id="tab0">
                <h3>User Management</h3>
                <div class="alert alert-success" id="userAlert"></div>

                <!-- Add/Edit User Form -->
                <div class="news-form">
                    <h4 id="userFormTitle">Add New User</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userName">Name</label>
                            <input type="text" id="userName" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label for="userEmail">Email</label>
                            <input type="email" id="userEmail" placeholder="Enter email address">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userSite">Site</label>
                            <input type="text" id="userSite" placeholder="Enter site/location">
                        </div>
                        <div class="form-group">
                            <label for="userRole">Role</label>
                            <select id="userRole">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                                <option value="doctor">Doctor</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" onclick="saveUser()" id="saveUserBtn">Send Invitation</button>
                        <button class="btn" onclick="cancelUserEdit()" id="cancelUserEditBtn" style="display: none;">Cancel Edit</button>
                    </div>
                </div>

                <!-- Users Table -->
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Site</th>
                            <th>Role</th>
                            <th>Assigned Trial</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr><td colspan="7">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="tab-content" id="tab1">
                <h3>News & Updates</h3>
                <div class="alert alert-success" id="newsAlert"></div>
                
                <div class="content-section active" id="documentsSection">
                    <div class="document-form">
                        <h4 id="documentFormTitle">Add News/Update or Upload Document</h4>

                        <!-- Document Type Selector -->
                        <div class="form-group">
                            <label for="documentType">Document Type</label>
                            <select id="documentType" onchange="toggleDocumentForm()">
                                <option value="news">News Item</option>
                                <option value="text">Text Document</option>
                                <option value="pdf">PDF Document</option>
                            </select>
                        </div>

                        <!-- Common fields for all document types -->
                        <div class="form-group">
                            <label for="documentTitle">Title</label>
                            <input type="text" id="documentTitle" placeholder="Enter title">
                        </div>

                        <!-- Clinical Trial Selector -->
                        <div class="form-group">
                            <label for="newsClinicalTrial">Clinical Trial</label>
                            <div id="newsClinicalTrialContainer">
                                <!-- Will be populated by JavaScript based on user role -->
                            </div>
                        </div>

                        <!-- Fields for News Items -->
                        <div id="newsFields" style="display: block;">
                            <div class="form-group">
                                <label for="newsContent">News Content</label>
                                <textarea id="newsContent" placeholder="Enter news content"></textarea>
                            </div>
                        </div>

                        <!-- Fields for Document uploads (Text/PDF) -->
                        <div id="documentFields" style="display: none;">
                            <div class="form-group">
                                <label for="documentDescription">Description</label>
                                <textarea id="documentDescription" placeholder="Enter document description"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="documentCategory">Category</label>
                                <input type="text" id="documentCategory" placeholder="e.g., Training, Updates, Guidelines">
                            </div>
                            <div class="form-group">
                                <label for="documentFile">File</label>
                                <input type="file" id="documentFile" accept=".pdf,.txt,.doc,.docx,.rtf">
                                <small style="color: #666; margin-top: 0.25rem; display: block;">Supported formats: PDF, TXT, DOC, DOCX, RTF</small>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem;">
                            <button class="btn-primary" id="documentSubmitBtn" onclick="saveDocument()">Add Document</button>
                            <button class="btn" id="documentCancelBtn" onclick="cancelDocumentEdit()" style="display: none;">Cancel</button>
                        </div>
                    </div>
                    <!-- News Items List -->
                    <div id="newsList" style="margin-top: 2rem;">
                        <h4>News & Updates</h4>
                        <div id="newsItemsList">Loading news...</div>
                    </div>

                    <!-- Documents List -->
                    <div id="documentsList" style="margin-top: 2rem;">
                        <h4>Documents</h4>
                        <div id="documentItemsList">Loading documents...</div>
                    </div>
                </div>

                <!-- PDF Viewer Modal -->
                <div id="pdfViewerModal" class="modal" style="display: none;">
                    <div class="modal-content pdf-modal">
                        <div class="modal-header">
                            <h3 id="pdfModalTitle">PDF Viewer</h3>
                            <span class="close" onclick="closePDFViewer()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="pdf-viewer-container">
                                <iframe id="pdfViewerFrame" src="" width="100%" height="600px" frameborder="0"></iframe>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="downloadCurrentPDF()">Download PDF</button>
                            <button class="btn" onclick="closePDFViewer()">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab2">
                <h3>Enrollment Leaderboard</h3>
                <div class="alert alert-success" id="leaderboardAlert"></div>
                
                <!-- Trial Summary -->
                <div class="summary-stats">
                    <div class="summary-stat">
                        <h3 id="totalConsented">0</h3>
                        <p>Total Consented</p>
                    </div>
                    <div class="summary-stat">
                        <h3 id="totalRandomized">0</h3>
                        <p>Total Randomized</p>
                    </div>
                    <div class="summary-stat">
                        <h3 id="totalHospitals">0</h3>
                        <p>Participating Sites</p>
                    </div>
                </div>

                <!-- Add/Edit Hospital Form -->
                <div class="news-form">
                    <h4 id="hospitalFormTitle">Add New Hospital</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hospitalName">Hospital Name</label>
                            <input type="text" id="hospitalName" placeholder="Enter hospital name">
                        </div>
                        <div class="form-group">
                            <label for="hospitalLocation">Location</label>
                            <input type="text" id="hospitalLocation" placeholder="City, State/Country">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="principalInvestigator">Principal Investigator</label>
                        <input type="text" id="principalInvestigator" placeholder="Enter Principal Investigator's name">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="consentedPatients">Consented Patients</label>
                            <input type="number" id="consentedPatients" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="randomizedPatients">Randomized Patients</label>
                            <input type="number" id="randomizedPatients" placeholder="0" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="consentRate">Consent Rate (per month)</label>
                        <input type="number" id="consentRate" placeholder="0" min="0" step="0.1">
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" onclick="saveHospital()" id="saveHospitalBtn">Add Hospital</button>
                        <button class="btn" onclick="cancelEdit()" id="cancelEditBtn" style="display: none;">Cancel Edit</button>
                    </div>
                </div>

                <!-- Leaderboard Table -->
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Hospital</th>
                            <th>Location</th>
                            <th>Principal Investigator</th>
                            <th>Consented</th>
                            <th>Randomized</th>
                            <th>Rate/Month</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardTableBody">
                        <tr><td colspan="8">Loading leaderboard...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="tab-content" id="tab3">
                <h3>Clinical Trials</h3>
                <div class="alert alert-success" id="trialAlert"></div>

                <!-- Add/Edit Trial Form -->
                <div class="news-form">
                    <h4 id="trialFormTitle">Add New Clinical Trial</h4>
                    <div class="form-row">
                        <div class="form-group form-group-wide">
                            <label for="trialName">Clinical Trial Name *</label>
                            <input type="text" id="trialName" placeholder="Enter trial name" required>
                        </div>
                        <div class="form-group form-group-narrow">
                            <label for="trialStartDate">Start Date</label>
                            <input type="date" id="trialStartDate">
                        </div>
                        <div class="form-group form-group-narrow">
                            <label for="trialEndDate">End Date</label>
                            <input type="date" id="trialEndDate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="trialDescription">Description</label>
                            <textarea id="trialDescription" placeholder="Enter trial description" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="trialStatus">Status</label>
                            <select id="trialStatus">
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="paused">Paused</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" onclick="saveTrial()" id="saveTrialBtn">Add Trial</button>
                        <button class="btn" onclick="cancelTrialEdit()" id="cancelTrialEditBtn" style="display: none;">Cancel Edit</button>
                    </div>
                </div>

                <!-- Trials Table -->
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Trial Name</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trialsTableBody">
                        <!-- Trials will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="tab-content" id="tab4">
                <h3>Training Materials</h3>
                <div class="alert alert-success" id="trainingAlert"></div>
                
                <!-- Add/Edit Training Material Form -->
                    <div class="news-form">
                    <h4 id="trainingFormTitle">Add New Training Material</h4>
                        <div class="form-group">
                            <label for="trainingTitle">Title</label>
                            <input type="text" id="trainingTitle" placeholder="Enter training material title">
                        </div>
                        <div class="form-group">
                            <label for="trainingDescription">Description</label>
                            <textarea id="trainingDescription" placeholder="Enter description"></textarea>
                        </div>

                        <!-- Clinical Trial Selector -->
                        <div class="form-group">
                            <label for="trainingClinicalTrial">Clinical Trial</label>
                            <select id="trainingClinicalTrial" required>
                                <option value="">Select a clinical trial...</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="trainingType">Type</label>
                                <select id="trainingType" onchange="toggleTrainingUploadOptions()">
                                    <option value="">Select type</option>
                                    <option value="text">Text Content</option>
                                    <option value="pdf">PDF Document</option>
                                    <option value="video">Video File</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="trainingCategory">Category</label>
                                <select id="trainingCategory">
                                    <option value="General">General</option>
                                    <option value="Safety">Safety Training</option>
                                    <option value="Procedure">Procedure Training</option>
                                    <option value="Compliance">Compliance</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="textContentSection" style="display: none;">
                            <div class="form-group">
                                <label for="trainingTextContent">Text Content</label>
                                <textarea id="trainingTextContent" placeholder="Enter the training content" rows="10"></textarea>
                            </div>
                        </div>
                        
                        <div id="fileUploadSection" style="display: none;">
                            <div class="form-group">
                                <label for="trainingFile">Upload File</label>
                                <input type="file" id="trainingFile" accept=".pdf,.mp4,.avi,.mov,.wmv">
                                <small>Supported formats: PDF, MP4, AVI, MOV, WMV</small>
                            </div>
                        </div>
                        
                    <div class="form-actions">
                        <button class="btn-primary" onclick="addTrainingMaterial()" id="trainingSubmitBtn">Add Training Material</button>
                        <button class="btn" onclick="cancelTrainingMaterialEdit()" id="trainingCancelBtn" style="display: none;">Cancel Edit</button>
                    </div>
                </div>

                <!-- Training Materials List -->
                <div class="materials-list">
                    <h4>Available Training Materials</h4>
                    <div id="trainingMaterialsList">Loading training materials...</div>
                </div>
            </div>

            <div class="tab-content" id="tab5">
                <h3>Study Protocol</h3>
                <div class="alert alert-success" id="protocolAlert"></div>
                
                <!-- Add/Edit Study Protocol Form -->
                    <div class="news-form">
                    <h4 id="protocolFormTitle">Add New Study Protocol</h4>
                        <div class="form-group">
                            <label for="protocolTitle">Protocol Title</label>
                            <input type="text" id="protocolTitle" placeholder="Enter protocol title">
                        </div>
                        <div class="form-group">
                            <label for="protocolDescription">Description</label>
                            <textarea id="protocolDescription" placeholder="Enter description"></textarea>
                        </div>

                        <!-- Clinical Trial Selector -->
                        <div class="form-group">
                            <label for="protocolClinicalTrial">Clinical Trial</label>
                            <select id="protocolClinicalTrial" required>
                                <option value="">Select a clinical trial...</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="protocolType">Type</label>
                                <select id="protocolType" onchange="toggleProtocolUploadOptions()">
                                    <option value="">Select type</option>
                                    <option value="text">Text Document</option>
                                    <option value="pdf">PDF Document</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="protocolVersion">Version</label>
                                <input type="text" id="protocolVersion" placeholder="e.g., 1.0, 2.1" value="1.0">
                            </div>
                        </div>
                        
                        <div id="protocolTextContentSection" style="display: none;">
                            <div class="form-group">
                                <label for="protocolTextContent">Protocol Content</label>
                                <textarea id="protocolTextContent" placeholder="Enter the protocol content" rows="15"></textarea>
                            </div>
                        </div>
                        
                        <div id="protocolFileUploadSection" style="display: none;">
                            <div class="form-group">
                                <label for="protocolFile">Upload PDF Document</label>
                                <div class="file-upload-area" id="protocolFileDropArea">
                                    <div class="file-upload-content">
                                        <div class="upload-icon">ðŸ“„</div>
                                        <div class="upload-text">
                                            <strong>Drop your PDF here</strong><br>
                                            or <span class="upload-link">click to browse</span>
                                        </div>
                                        <div class="upload-hint">Supported formats: PDF only (max 10MB)</div>
                                        <div class="selected-file" id="protocolSelectedFile" style="display: none;"></div>
                                    </div>
                                    <input type="file" id="protocolFile" accept=".pdf" style="display: none;">
                                </div>
                            </div>
                        </div>
                        
                    <div class="form-actions">
                        <button class="btn-primary" onclick="addStudyProtocol()" id="protocolSubmitBtn">Add Study Protocol</button>
                        <button class="btn" onclick="cancelStudyProtocolEdit()" id="protocolCancelBtn" style="display: none;">Cancel Edit</button>
                    </div>
                </div>

                <!-- Study Protocols List -->
                <div class="materials-list">
                    <h4>Available Study Protocols</h4>
                    <div id="studyProtocolsList">Loading study protocols...</div>
                </div>
            </div>

            <div class="tab-content" id="tab5">
                <h3>Analytics</h3>
                
                <div class="analytics-header">
                    <h4>User Engagement Analytics</h4>
                    <button onclick="refreshAnalytics()" class="btn-primary">
                        <i class="fas fa-sync"></i> Refresh Data
                    </button>
                </div>

                <div class="analytics-filters">
                    <select id="analyticsFilter" onchange="filterAnalytics()">
                        <option value="all">All Users</option>
                        <option value="active">Active Users (Last 7 Days)</option>
                        <option value="inactive">Inactive Users (No Activity > 30 Days)</option>
                    </select>
                </div>

                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h5>Overall Engagement</h5>
                        <div class="stat-number" id="totalAppOpens">-</div>
                        <div class="stat-label">Total App Opens</div>
                    </div>
                    <div class="analytics-card">
                        <h5>Active Users</h5>
                        <div class="stat-number" id="activeUsers">-</div>
                        <div class="stat-label">Users Active in Last 7 Days</div>
                    </div>
                </div>

                <div class="analytics-table-container">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Site</th>
                                <th>Last Active</th>
                                <th>Total App Opens</th>
                                <th>Most Viewed Tab</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="analyticsTableBody">
                            <tr><td colspan="6">Loading analytics...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- User Details Modal -->
                <div id="userAnalyticsModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h4>User Analytics Details</h4>
                        <div id="userAnalyticsDetails"></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab6">
                <h3>Company Settings</h3>
                <p>Company configuration and preferences will be managed here.</p>
                <p>This could include:</p>
                <ul style="margin-left: 2rem; margin-top: 1rem;">
                    <li>Notification preferences</li>
                    <li>Auto-approval settings</li>
                    <li>Branding customization</li>
                    <li>Security settings</li>
                </ul>
            </div>

            <div class="tab-content" id="tab7">
                <h3>Debug & Troubleshooting</h3>
                
                <div class="debug-panel">
                    <h4>Logo Loading Status</h4>
                    <pre id="logoDebugInfo">Checking logo loading...</pre>
                </div>

                <div class="debug-panel">
                    <h4>Company Information</h4>
                    <pre id="companyDebugInfo">Loading company info...</pre>
                </div>

                <div class="debug-panel">
                    <h4>Logo Test Links</h4>
                    <button onclick="testLogoAccess()">Test Logo Access</button>
                    <div id="logoTestResults" style="margin-top: 1rem;"></div>
                </div>

                <div class="debug-panel">
                    <h4>API Testing</h4>
                    <button onclick="testHospitalAPI()">Test Hospital API</button>
                    <button onclick="testServerConnectivity()">Test Server Connection</button>
                    <button onclick="testBasicEndpoint()">Test Basic Endpoint</button>
                    <button onclick="checkAvailableEndpoints()">Check Endpoints</button>
                    <pre id="apiTestResults">Click buttons to test APIs...</pre>
                </div>

                <div class="debug-panel">
                    <h4>Data Management</h4>
                    <button onclick="exportCurrentData()">Export Current Data</button>
                    <button onclick="showRestoreForm()">Restore Data</button>
                    <button onclick="exportFromLeaderboard()">Export from Leaderboard</button>
                    
                    <div id="restoreForm">
                        <h5>Paste your backup data below:</h5>
                        <textarea id="restoreDataTextarea" placeholder="Paste your JSON backup data here..."></textarea>
                        <button class="btn-primary" onclick="restoreData()">Restore Data</button>
                        <button class="btn" onclick="hideRestoreForm()">Cancel</button>
                    </div>
                    
                    <div id="exportResults" style="margin-top: 1rem;"></div>
                </div>
            </div>

            <div class="tab-content" id="tab7">
                <h3>Messaging</h3>

                <div class="messaging-container">
                    <div class="messaging-sidebar">
                        <div class="messaging-header">
                            <h4>Conversations</h4>
                            <button class="btn-primary" onclick="composeNewMessage()">New Message</button>
                        </div>
                        <div class="conversations-list" id="conversationsList">
                            <div class="loading">Loading conversations...</div>
                        </div>
                    </div>

                    <div class="messaging-main">
                        <div class="message-thread" id="messageThread">
                            <div class="no-conversation">
                                <div class="no-conversation-icon">ðŸ’¬</div>
                                <h4>Select a conversation</h4>
                                <p>Choose a conversation from the sidebar to view messages</p>
                            </div>
                        </div>

                        <div class="message-compose" id="messageCompose">
                            <div class="compose-header">
                                <span id="composeRecipient">Select recipient</span>
                                <button onclick="cancelCompose()">âœ•</button>
                            </div>
                            <div class="compose-body">
                                <textarea id="messageInput" placeholder="Type your message..."></textarea>
                                <div class="compose-actions">
                                    <button onclick="sendMessage()" class="btn-primary">Send Message</button>
                                    <button onclick="cancelCompose()">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab8">
                <h3>Debug & Troubleshooting</h3>

    <script>
        let currentCompany = '';
        let companyInfo = null;
        let editingHospitalId = null;
        let clinicalTrials = []; // Store clinical trials data for assignment dropdown

        // Initialize dashboard
        window.onload = async function() {
            console.log('ðŸš€ Page loaded, checking dropdown elements...');

            // Check if dropdown elements exist
            const dropdowns = ['newsClinicalTrial', 'trainingClinicalTrial', 'protocolClinicalTrial'];
            dropdowns.forEach(id => {
                const el = document.getElementById(id);
                console.log(`ðŸ” Dropdown ${id} exists:`, el ? 'YES' : 'NO');
            });

            const urlParams = new URLSearchParams(window.location.search);
            currentCompany = urlParams.get('company');

            if (!currentCompany) {
                // Default to cerevasc if no company specified
                currentCompany = 'cerevasc';
            }

            // Load company info from localStorage or set defaults
            const stored = localStorage.getItem('companyInfo');
            if (stored) {
                companyInfo = JSON.parse(stored);
            } else {
                companyInfo = {
                    name: currentCompany === 'cerevasc' ? 'CereVasc' : 'Medtronic',
                    logoUrl: currentCompany === 'cerevasc' 
                        ? 'http://localhost:3000/logos/cerevasc-logo.png'
                        : 'http://localhost:3000/logos/medtronic-logo.svg'
                };
                // Store for future use
                localStorage.setItem('companyInfo', JSON.stringify(companyInfo));
            }
            
            // Set static dashboard title
            const dashboardTitle = document.querySelector('.dashboard-title');
            if (dashboardTitle) {
                dashboardTitle.textContent = 'App Dashboard';
            }

            // Logo functionality removed

            // Fetch user profile and initialize tabs based on role
            const userProfile = await fetchUserProfile();
            initializeTabs();

            // Load clinical trials for dropdowns - try even if user profile fetch failed
            const token = localStorage.getItem('token');
            if (token) {
                console.log('ðŸŽ¯ About to call loadClinicalTrials()');
                await loadClinicalTrials();
                console.log('âœ… loadClinicalTrials() completed');
            } else {
                console.log('âš ï¸ Skipping loadClinicalTrials() - no auth token');
            }

            loadDashboardData();
            loadPDFDocuments();
            loadLeaderboard();
            initializeFileUpload();
            testLogoAccess();
            testServerConnectivity();
        };

        function showTab(index) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab
            tabContents[index].classList.add('active');
            tabButtons[index].classList.add('active');

            // Load content when tabs are shown
            if (index === 1) {
                loadNewsItems(); // News & Updates tab
                // Ensure clinical trial selector is populated for the current user role
                setTimeout(() => {
                    populateNewsClinicalTrialSelector();
                }, 100);
            } else if (index === 2) {
                loadUsers(); // Users tab
            } else if (index === 3) {
                loadTrials(); // Clinical Trials tab
            } else if (index === 4) {
                loadTrainingMaterials(); // Training Materials tab
            } else if (index === 5) {
                loadStudyProtocols(); // Study Protocol tab
            } else if (index === 6) {
                loadMessages(); // Messaging tab
            }
        }

        function toggleDocumentForm() {
            const documentType = document.getElementById('documentType').value;
            const newsFields = document.getElementById('newsFields');
            const documentFields = document.getElementById('documentFields');

            if (documentType === 'news') {
                newsFields.style.display = 'block';
                documentFields.style.display = 'none';
            } else {
                newsFields.style.display = 'none';
                documentFields.style.display = 'block';
            }
        }

        // Initialize drag-and-drop functionality for file uploads
        function initializeFileUpload() {
            const dropArea = document.getElementById('protocolFileDropArea');
            const fileInput = document.getElementById('protocolFile');
            const selectedFileDiv = document.getElementById('protocolSelectedFile');

            if (!dropArea) return;

            // Click to open file dialog
            dropArea.addEventListener('click', () => {
                fileInput.click();
            });

            // File input change handler
            fileInput.addEventListener('change', (e) => {
                handleFileSelect(e.target.files);
            });

            // Drag and drop handlers
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            dropArea.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight(e) {
                dropArea.classList.add('dragover');
            }

            function unhighlight(e) {
                dropArea.classList.remove('dragover');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFileSelect(files);
            }

            function handleFileSelect(files) {
                if (files.length > 0) {
                    const file = files[0];

                    // Validate file type
                    if (file.type !== 'application/pdf') {
                        showAlert('protocolAlert', 'Please select a PDF file only.', 'error');
                        fileInput.value = '';
                        selectedFileDiv.style.display = 'none';
                        return;
                    }

                    // Validate file size (10MB limit)
                    if (file.size > 10 * 1024 * 1024) {
                        showAlert('protocolAlert', 'File size must be less than 10MB.', 'error');
                        fileInput.value = '';
                        selectedFileDiv.style.display = 'none';
                        return;
                    }

                    // Show selected file
                    selectedFileDiv.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                    selectedFileDiv.style.display = 'block';

                    // Update upload text
                    const uploadText = dropArea.querySelector('.upload-text');
                    uploadText.innerHTML = '<strong>File selected!</strong><br>Drop another file or click to change';
                } else {
                    selectedFileDiv.style.display = 'none';
                    const uploadText = dropArea.querySelector('.upload-text');
                    uploadText.innerHTML = '<strong>Drop your PDF here</strong><br>or <span class="upload-link">click to browse</span>';
                }
            }
        }

        async function loadDashboardData() {
            try {
                const token = localStorage.getItem('token');

                // Load dashboard stats
                const statsResponse = await fetch(`${window.API_BASE_URL}/api/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const statsData = await statsResponse.json();

                if (statsResponse.ok && statsData.success) {
                    document.getElementById('totalUsers').textContent = statsData.totalUsers;
                    document.getElementById('pendingApprovals').textContent = statsData.pendingApprovals;
                    document.getElementById('activeUsers').textContent = statsData.activeUsers;
                    document.getElementById('newsItems').textContent = statsData.newsItems;
                }

                // Load users, news, leaderboard, etc. separately
                await Promise.all([
                    loadUsers(),
                    loadNewsItems(),
                    loadLeaderboard(),
                    loadDocuments()
                ]);
            } catch (error) {
                console.error('âŒ Error loading dashboard data:', error);
            }
        }

        function updateStats(stats) {
            console.log('ðŸ”„ Updating stats with:', stats);
            try {
                const totalUsersEl = document.getElementById('totalUsers');
                const pendingApprovalsEl = document.getElementById('pendingApprovals');
                const activeUsersEl = document.getElementById('activeUsers');
                const newsItemsEl = document.getElementById('newsItems');
                
                if (totalUsersEl) totalUsersEl.textContent = stats.totalUsers;
                if (pendingApprovalsEl) pendingApprovalsEl.textContent = stats.pendingApprovals;
                if (activeUsersEl) activeUsersEl.textContent = stats.activeUsers;
                if (newsItemsEl) newsItemsEl.textContent = stats.newsItems;
                
                console.log('âœ… Stats updated successfully');
            } catch (error) {
                console.error('âŒ Error updating stats:', error);
            }
        }

        // Global variable to store current user role
        let currentUserRole = null;

        async function fetchUserProfile() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.warn('No auth token found');
                    return null;
                }

                const response = await fetch(`${window.API_BASE_URL}/api/user/profile`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.profile) {
                        currentUserRole = data.profile.role;
                        console.log('ðŸ“‹ User role loaded:', currentUserRole);
                        return data.profile;
                    }
                } else {
                    console.error('Failed to fetch user profile:', response.status);
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
            }
            return null;
        }

        function initializeTabs() {
            const tabButtonsContainer = document.querySelector('.tab-buttons');
            const tabContents = document.querySelectorAll('.tab-content');

            // Clear existing tab buttons
            tabButtonsContainer.innerHTML = '';

            // Define all possible tabs with their indices
            const allTabs = [
                { index: 0, name: 'User Management', show: true },
                { index: 1, name: 'News & Updates', show: true },
                { index: 2, name: 'Enrollment Leaderboard', show: true },
                { index: 3, name: 'Clinical Trials', show: currentUserRole === 'admin' },
                { index: 4, name: 'Training Materials', show: true },
                { index: 5, name: 'Study Protocol', show: true },
                { index: 6, name: 'Analytics', show: true },
                { index: 7, name: 'Settings', show: true }
            ];

            // Filter tabs based on user role and create buttons
            let visibleTabIndex = 0;
            allTabs.forEach(tab => {
                if (tab.show) {
                    const button = document.createElement('button');
                    button.className = 'tab-button' + (visibleTabIndex === 0 ? ' active' : '');
                    button.onclick = () => showTab(tab.index);
                    button.textContent = tab.name;
                    tabButtonsContainer.appendChild(button);

                    // Show/hide corresponding tab content
                    const content = document.getElementById(`tab${tab.index}`);
                    if (content) {
                        if (visibleTabIndex === 0) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    }

                    visibleTabIndex++;
                } else {
                    // Hide tab content for non-visible tabs
                    const content = document.getElementById(`tab${tab.index}`);
                    if (content) {
                        content.classList.remove('active');
                    }
                }
            });

            console.log(`ðŸ“‹ Tabs initialized for role: ${currentUserRole}`);
        }

        async function loadUsers() {
            try {
                // Ensure clinical trials are loaded for the user assignment dropdowns
                if (!clinicalTrials || clinicalTrials.length === 0) {
                    console.log('ðŸ”„ Clinical trials not loaded yet, loading them for user management...');
                    await loadClinicalTrials();
                }

                const token = localStorage.getItem('token');
                const response = await fetch(`${window.API_BASE_URL}/api/users`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateUserTable(data.users);
                } else {
                    updateUserTable([]);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                updateUserTable([]);
            }
        }

        async function loadClinicalTrials() {
            console.log('ðŸš€ loadClinicalTrials called');
            try {
                const token = localStorage.getItem('token');
                console.log('ðŸ”‘ Token present:', !!token);
                const response = await fetch(`${window.API_BASE_URL}/api/clinical-trials`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                console.log('ðŸ“¡ API Response status:', response.status);
                const data = await response.json();
                console.log('ðŸ“¦ API Response data:', data);

                if (response.ok && data.success) {
                    clinicalTrials = data.trials || [];
                    console.log('ðŸ“‹ Loaded clinical trials for assignment dropdown:', clinicalTrials.length);
                    console.log('ðŸ“‹ Clinical trials data:', clinicalTrials);

                    // Populate clinical trial dropdowns
                    await populateClinicalTrialDropdowns();
                } else {
                    console.error('Failed to load clinical trials:', data.message);
                    clinicalTrials = [];
                }
            } catch (error) {
                console.error('Error loading clinical trials:', error);
                clinicalTrials = [];
            }
        }

        async function populateClinicalTrialDropdowns() {
            console.log('ðŸ”„ populateClinicalTrialDropdowns called');
            console.log('ðŸ“Š clinicalTrials array:', clinicalTrials);
            console.log('ðŸ“Š clinicalTrials length:', clinicalTrials ? clinicalTrials.length : 'undefined');

            const dropdowns = ['trainingClinicalTrial', 'protocolClinicalTrial'];

            // Handle regular dropdowns
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                console.log(`ðŸ” Checking dropdown ${dropdownId}:`, dropdown ? 'Found' : 'NOT FOUND');

                if (dropdown) {
                    // Clear existing options except the first one
                    dropdown.innerHTML = '<option value="">Select a clinical trial...</option>';
                    console.log(`ðŸ§¹ Cleared dropdown ${dropdownId}`);

                    // Add clinical trial options
                    if (clinicalTrials && clinicalTrials.length > 0) {
                        clinicalTrials.forEach(trial => {
                            const option = document.createElement('option');
                            option.value = trial.id;
                            option.textContent = trial.trial_name;
                            dropdown.appendChild(option);
                            console.log(`âž• Added option: ${trial.trial_name} (${trial.id}) to ${dropdownId}`);
                        });
                        console.log(`ðŸ“‹ Successfully populated ${dropdownId} with ${clinicalTrials.length} trials`);
                    } else {
                        console.log(`âš ï¸ No clinical trials to populate for ${dropdownId}`);
                    }
                } else {
                    console.error(`âŒ Dropdown ${dropdownId} not found in DOM`);
                }
            });

            // Handle news clinical trial container with role-based logic
            await populateNewsClinicalTrialSelector();
        }

        async function populateNewsClinicalTrialSelector() {
            const container = document.getElementById('newsClinicalTrialContainer');
            if (!container) {
                console.error('âŒ News clinical trial container not found');
                return;
            }

            console.log('ðŸ”„ Populating news clinical trial selector for role:', currentUserRole);

            if (currentUserRole === 'admin') {
                // Admin users see dropdown with all trials
                const select = document.createElement('select');
                select.id = 'newsClinicalTrial';
                select.required = true;
                select.innerHTML = '<option value="">Select a clinical trial...</option>';

                if (clinicalTrials && clinicalTrials.length > 0) {
                    clinicalTrials.forEach(trial => {
                        const option = document.createElement('option');
                        option.value = trial.id;
                        option.textContent = trial.trial_name;
                        select.appendChild(option);
                    });
                    console.log(`ðŸ“‹ Admin: populated dropdown with ${clinicalTrials.length} trials`);
                }

                container.innerHTML = '';
                container.appendChild(select);
            } else {
                // Non-admin users see read-only field with their assigned trial
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${window.API_BASE_URL}/api/user/profile`, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.profile) {
                            const assignment = data.profile.user_clinical_assignments?.[0];
                            const trialName = assignment?.clinical_trials?.name || 'Unassigned';
                            const trialId = assignment?.clinical_trial_id || '';

                            // Create read-only display
                            const display = document.createElement('div');
                            display.style.cssText = 'padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f5f5f5; color: #666; font-style: italic;';
                            display.textContent = trialName;

                            // Hidden input to store the value for form submission
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.id = 'newsClinicalTrial';
                            hiddenInput.value = trialId;

                            container.innerHTML = '';
                            container.appendChild(display);
                            container.appendChild(hiddenInput);

                            console.log(`ðŸ“‹ User: showing assigned trial "${trialName}" (ID: ${trialId})`);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching user assignment for news selector:', error);
                    container.innerHTML = '<div style="color: red;">Error loading clinical trial assignment</div>';
                }
            }
        }

        function updateUserTable(users) {
            const tbody = document.getElementById('userTableBody');

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                // Determine what to show in the Assigned Trial column
                let assignedTrialDisplay = '';

                if (currentUserRole === 'admin') {
                    // Admin users see dropdowns to assign trials to all users
                    const currentAssignment = user.user_clinical_assignments?.[0];
                    const selectedTrialId = currentAssignment?.clinical_trial_id || '';

                    // Create dropdown options
                    const options = [
                        '<option value="">Unassigned</option>',
                        ...clinicalTrials.map(trial =>
                            `<option value="${trial.id}" ${selectedTrialId === trial.id ? 'selected' : ''}>${trial.trial_name}</option>`
                        )
                    ].join('');

                    assignedTrialDisplay = `<select onchange="updateUserTrialAssignment('${user.id}', this.value)" style="width: 100%; max-width: 200px;">${options}</select>`;
                } else {
                    // Non-admin users see read-only display
                    if (user.role === 'admin') {
                        // Admins have access to all trials, show blank
                        assignedTrialDisplay = '';
                    } else {
                        // For non-admin users, show their assignment or "Unassigned"
                        const assignment = user.user_clinical_assignments?.[0];
                        if (assignment?.clinical_trials?.name) {
                            assignedTrialDisplay = `<span style="opacity: 0.7;">${assignment.clinical_trials.name}</span>`;
                        } else {
                            assignedTrialDisplay = `<span style="opacity: 0.7;">Unassigned</span>`;
                        }
                    }
                }

                return `
                <tr>
                    <td>${user.display_name || 'N/A'}</td>
                    <td>N/A</td>
                    <td>${user.organizations?.name || 'N/A'}</td>
                    <td>${user.role}</td>
                    <td>${assignedTrialDisplay}</td>
                    <td>
                        <span class="status-badge status-active">
                            Active
                        </span>
                    </td>
                    <td>
                        <button onclick="editUser('${user.id}', '${user.display_name || ''}', '${user.role}')" class="btn-edit">Edit</button>
                        <button onclick="deleteUser('${user.id}')" class="btn-delete">Delete</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        async function updateUserTrialAssignment(userId, clinicalTrialId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${window.API_BASE_URL}/api/users/${userId}/clinical-assignment`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({
                        clinical_trial_id: clinicalTrialId || null
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    console.log('âœ… Clinical trial assignment updated successfully');
                    showAlert('Clinical trial assignment updated successfully', 'success');

                    // Reload users to reflect changes
                    loadUsers();
                } else {
                    console.error('Failed to update assignment:', data.message);
                    showAlert('Failed to update clinical trial assignment: ' + data.message, 'error');

                    // Reload users to revert the dropdown
                    loadUsers();
                }
            } catch (error) {
                console.error('Error updating clinical trial assignment:', error);
                showAlert('An error occurred while updating the assignment', 'error');

                // Reload users to revert the dropdown
                loadUsers();
            }
        }

        function updateNewsList(news) {
            const newsList = document.getElementById('newsItemsList');
            
            if (news.length === 0) {
                newsList.innerHTML = '<p>No news items found</p>';
                return;
            }

            newsList.innerHTML = news.map(item => `
                <div style="background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; border-left: 4px solid #1976d2;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h5 style="margin-bottom: 0.5rem;">${item.title}</h5>
                            <p style="color: #666; margin-bottom: 0.5rem;">${item.content}</p>
                            <small style="color: #999;">
                                ${new Date(item.created_at).toLocaleDateString()}
                                ${item.created_by_name ? ` â€¢ By ${item.created_by_name}` : ''}
                            </small>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                            <button class="btn-edit" onclick="editNews('${item.id}', '${item.title.replace(/'/g, "\\'")}', '${item.content.replace(/'/g, "\\'")}', '${item.clinical_trial_id}')">Edit</button>
                            <button class="btn-delete" onclick="deleteNews('${item.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');

            // News buttons use inline onclick handlers
        }

        async function approveUser(userId) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/users/${userId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                // Show success message with preview link
                const userAlert = document.getElementById('userAlert');
                userAlert.innerHTML = `
                    User approved successfully! 
                    <a href="${data.emailPreviewUrl}" target="_blank" style="color: blue; text-decoration: underline;">
                        View Email
                    </a>
                `;
                userAlert.style.display = 'block';

                // Refresh user list
                loadUsers();

                // Hide alert after 10 seconds
                setTimeout(() => {
                    userAlert.style.display = 'none';
                }, 10000);

            } catch (error) {
                console.error('Failed to approve user:', error);
                alert('Failed to approve user. Please try again.');
            }
        }

        async function revokeAccess(userId) {
            if (!confirm('Are you sure you want to revoke this user\'s access? They will no longer be able to use the mobile app.')) {
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/users/${userId}/revoke`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error('Failed to revoke access');

                // Show success message
                const userAlert = document.getElementById('userAlert');
                userAlert.textContent = 'User access revoked successfully';
                userAlert.style.display = 'block';

                // Refresh user list
                loadUsers();

                // Hide alert after 3 seconds
                setTimeout(() => {
                    userAlert.style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error('Failed to revoke access:', error);
                alert('Failed to revoke user access. Please try again.');
            }
        }

        // User Management Functions
        async function saveUser() {
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const site = document.getElementById('userSite').value.trim();
            const role = document.getElementById('userRole').value;

            if (!name || !email || !site) {
                showAlert('userAlert', 'Please fill in all required fields', 'error');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('userAlert', 'Please enter a valid email address', 'error');
                return;
            }

            try {
                // Determine if we're adding or editing
                const isEditing = editingUserId !== null;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `${window.API_BASE_URL}/api/users/${editingUserId}` : '${window.API_BASE_URL}/api/users';

                const token = localStorage.getItem('token');
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify(
                        isEditing ?
                        { displayName: name, role } : // For updates, only send changeable fields
                        { email, role, displayName: name, clinicalTrialId: null } // For creation, send all fields
                    )
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert('userAlert', `User ${isEditing ? 'updated' : 'invitation sent'} successfully!`, 'success');

                    // Clear form
                    cancelUserEdit();

                    // Refresh user list
                    loadUsers();
                } else {
                    showAlert('userAlert', data.message || `Failed to ${isEditing ? 'update' : 'send invitation'}`, 'error');
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showAlert('userAlert', 'Error sending invitation. Please try again.', 'error');
            }
        }

        function cancelUserEdit() {
            // Clear form
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userSite').value = '';
            document.getElementById('userRole').value = 'user';

            // Reset form title and button
            document.getElementById('userFormTitle').textContent = 'Send User Invitation';
            document.getElementById('saveUserBtn').textContent = 'Send Invitation';
            document.getElementById('cancelUserEditBtn').style.display = 'none';

            // Reset editing state
            editingUserId = null;
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${window.API_BASE_URL}/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });

                if (response.ok) {
                    showAlert('userAlert', 'User deleted successfully!', 'success');
                    // Refresh user list
                    loadUsers();
                } else {
                    const errorData = await response.json();
                    showAlert('userAlert', errorData.message || 'Failed to delete user', 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('userAlert', 'Error deleting user. Please try again.', 'error');
            }
        }

        function editUser(userId, displayName, role) {
            // Populate form with user data passed from the button
            document.getElementById('userName').value = displayName || '';
            document.getElementById('userEmail').value = ''; // Email can't be changed
            document.getElementById('userSite').value = ''; // Not used in new schema
            document.getElementById('userRole').value = role || 'user';

            // Update form state
            document.getElementById('userFormTitle').textContent = 'Edit User';
            document.getElementById('saveUserBtn').textContent = 'Update User';
            document.getElementById('cancelUserEditBtn').style.display = 'inline-block';

            // Set editing state
            editingUserId = userId;

            // Scroll to form
            document.querySelector('.news-form').scrollIntoView({ behavior: 'smooth' });
        }

        // ============================================================================
        // CLINICAL TRIALS FUNCTIONS
        // ============================================================================

        async function loadTrials() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${window.API_BASE_URL}/api/clinical-trials`, {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateTrialsTable(data.trials);
                } else {
                    showAlert('trialAlert', data.message || 'Failed to load trials', 'error');
                }
            } catch (error) {
                console.error('Error loading trials:', error);
                showAlert('trialAlert', 'Error loading trials. Please try again.', 'error');
            }
        }

        function updateTrialsTable(trials) {
            const tableBody = document.getElementById('trialsTableBody');

            if (trials.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">No clinical trials found</td></tr>';
                return;
            }

            tableBody.innerHTML = trials.map(trial => `
                <tr>
                    <td>${trial.trial_name || ''}</td>
                    <td>${trial.description ? trial.description.substring(0, 100) + (trial.description.length > 100 ? '...' : '') : ''}</td>
                    <td>
                        <span class="status-badge status-${trial.status || 'active'}">
                            ${(trial.status || 'active').charAt(0).toUpperCase() + (trial.status || 'active').slice(1)}
                        </span>
                    </td>
                    <td>${trial.start_date ? new Date(trial.start_date).toLocaleDateString() : ''}</td>
                    <td>${trial.end_date ? new Date(trial.end_date).toLocaleDateString() : ''}</td>
                    <td>
                        <button onclick="editTrial('${trial.id}')" class="btn-edit">Edit</button>
                        <button onclick="deleteTrial('${trial.id}')" class="btn-delete">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveTrial() {
            const trialName = document.getElementById('trialName').value.trim();
            const description = document.getElementById('trialDescription').value.trim();
            const status = document.getElementById('trialStatus').value;
            const startDate = document.getElementById('trialStartDate').value;
            const endDate = document.getElementById('trialEndDate').value;
            const token = localStorage.getItem('token');

            console.log('ðŸ“¤ saveTrial called with:', { trialName, description, status, isEditing: editingTrialId !== null });

            if (!trialName) {
                showAlert('trialAlert', 'Please enter a trial name', 'error');
                return;
            }

            try {
                // Determine if we're adding or editing
                const isEditing = editingTrialId !== null;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `${window.API_BASE_URL}/api/clinical-trials/${editingTrialId}` : '${window.API_BASE_URL}/api/clinical-trials';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                    body: JSON.stringify({
                        name: trialName,
                        description: description,
                        isActive: status === 'active'
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert('trialAlert', `Clinical trial ${isEditing ? 'updated' : 'added'} successfully!`, 'success');

                    // Clear form
                    cancelTrialEdit();

                    // Refresh trials list
                    loadTrials();
                } else {
                    showAlert('trialAlert', data.message || `Failed to ${isEditing ? 'update' : 'add'} trial`, 'error');
                }
            } catch (error) {
                console.error('Error saving trial:', error);
                showAlert('trialAlert', 'Error saving trial. Please try again.', 'error');
            }
        }

        function editTrial(trialId) {
            const token = localStorage.getItem('token');
            // Fetch trial data
            fetch(`${window.API_BASE_URL}/api/clinical-trials`, {
                headers: {
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.trials) {
                        const trial = data.trials.find(t => t.id === trialId);
                        if (trial) {
                            console.log('ðŸ“ Populating form with trial data:', trial);
                            // Populate form with trial data
                            document.getElementById('trialName').value = trial.trial_name || '';
                            document.getElementById('trialDescription').value = trial.description || '';
                            document.getElementById('trialStatus').value = trial.status || 'active';
                            document.getElementById('trialStartDate').value = trial.start_date ? trial.start_date.split('T')[0] : '';
                            document.getElementById('trialEndDate').value = trial.end_date ? trial.end_date.split('T')[0] : '';

                            console.log('ðŸ“ Form populated - trialName value:', document.getElementById('trialName').value);

                            // Update form state
                            document.getElementById('trialFormTitle').textContent = 'Edit Clinical Trial';
                            document.getElementById('saveTrialBtn').textContent = 'Update Trial';
                            document.getElementById('cancelTrialEditBtn').style.display = 'inline-block';

                            // Set editing state
                            editingTrialId = trialId;

                            // Scroll to form
                            document.querySelector('#tab3 .news-form').scrollIntoView({ behavior: 'smooth' });
                        } else {
                            showAlert('trialAlert', 'Trial not found', 'error');
                        }
                    } else {
                        showAlert('trialAlert', 'Failed to load trial data', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading trial:', error);
                    showAlert('trialAlert', 'Failed to load trial data', 'error');
                });
        }

        async function deleteTrial(trialId) {
            if (!confirm('Are you sure you want to delete this clinical trial? This action cannot be undone.')) {
                return;
            }

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${window.API_BASE_URL}/api/clinical-trials/${trialId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });

                if (response.ok) {
                    showAlert('trialAlert', 'Clinical trial deleted successfully!', 'success');
                    // Refresh trials list
                    loadTrials();
                } else {
                    const errorData = await response.json();
                    showAlert('trialAlert', errorData.message || 'Failed to delete trial', 'error');
                }
            } catch (error) {
                console.error('Error deleting trial:', error);
                showAlert('trialAlert', 'Error deleting trial. Please try again.', 'error');
            }
        }

        function cancelTrialEdit() {
            // Clear form
            document.getElementById('trialName').value = '';
            document.getElementById('trialDescription').value = '';
            document.getElementById('trialStatus').value = 'active';
            document.getElementById('trialStartDate').value = '';
            document.getElementById('trialEndDate').value = '';

            // Reset form title and button
            document.getElementById('trialFormTitle').textContent = 'Add New Clinical Trial';
            document.getElementById('saveTrialBtn').textContent = 'Add Trial';
            document.getElementById('cancelTrialEditBtn').style.display = 'none';

            // Reset editing state
            editingTrialId = null;
        }

        let editingNewsId = null;
        let editingUserId = null;
        let editingTrialId = null;
        let editingTrainingMaterialId = null;
        let editingStudyProtocolId = null;

        // ============================================================================
        // CLINICAL TRIALS DROPDOWN FUNCTIONS
        // ============================================================================


        async function loadNewsItems() {
            try {
                // Ensure clinical trials are loaded for the news creation dropdown
                if (!clinicalTrials || clinicalTrials.length === 0) {
                    console.log('ðŸ”„ Clinical trials not loaded yet, loading them for news management...');
                    await loadClinicalTrials();
                }

                const token = localStorage.getItem('token');
                const response = await fetch(`${window.API_BASE_URL}/api/news`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateNewsList(data.newsItems || []);
                } else {
                    updateNewsList([]);
                }
            } catch (error) {
                console.error('Error loading news items:', error);
                updateNewsList([]);
            }
        }


        async function saveDocument() {
            const documentType = document.getElementById('documentType').value;
            const title = document.getElementById('documentTitle').value;

            if (!title) {
                showAlert('newsAlert', 'Please enter a title', 'error');
                return;
            }

            try {
                if (documentType === 'news') {
                    // Handle news items
                    const content = document.getElementById('newsContent').value;

                    if (!content) {
                        showAlert('newsAlert', 'Please enter news content', 'error');
                        return;
                    }

                    const clinical_trial_id = document.getElementById('newsClinicalTrial').value;

                    if (!clinical_trial_id) {
                        showAlert('newsAlert', 'Please select a clinical trial', 'error');
                        return;
                    }

                    const token = localStorage.getItem('token');
                    const isEditing = editingNewsId !== null;
                    const url = isEditing
                        ? `${window.API_BASE_URL}/api/news/${editingNewsId}`
                        : '${window.API_BASE_URL}/api/news';
                    const method = isEditing ? 'PUT' : 'POST';

                    console.log(`ðŸ“¤ ${method} ${url} - Editing: ${isEditing}, NewsId: ${editingNewsId}`);

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify({
                            title,
                            content: content,
                            clinical_trial_id: clinical_trial_id
                        })
                    });

                    const data = await response.json();
                    console.log('ðŸ“¥ Response:', response.status, data);

                    if (response.ok && data.success) {
                        showAlert('newsAlert', `News ${isEditing ? 'updated' : 'added'} successfully!`, 'success');
                        cancelDocumentEdit();
                        loadNewsItems();
                    } else {
                        showAlert('newsAlert', data.message || `Failed to ${isEditing ? 'update' : 'add'} news`, 'error');
                    }
                } else {
                    // Handle document uploads (PDF/Text)
                    const description = document.getElementById('documentDescription').value;
                    const category = document.getElementById('documentCategory').value;
                    const fileInput = document.getElementById('documentFile');

                    if (!description || !fileInput.files[0]) {
                        showAlert('newsAlert', 'Please fill in all fields and select a file', 'error');
                        return;
                    }

                    // Validate file type
                    const allowedTypes = ['application/pdf', 'text/plain', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/rtf'];
                    const file = fileInput.files[0];

                    if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|txt|doc|docx|rtf)$/i)) {
                        showAlert('newsAlert', 'Please select a valid file (PDF, TXT, DOC, DOCX, or RTF)', 'error');
                        return;
                    }

                    // Create FormData for file upload
                    const formData = new FormData();
                    formData.append('title', title);
                    formData.append('description', description);
                    formData.append('category', category || 'General');
                    formData.append('file', file);

                    const token = localStorage.getItem('token');
                    const response = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/documents`, {
                        method: 'POST',
                        headers: {
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showAlert('newsAlert', `${documentType.toUpperCase()} document added successfully!`, 'success');
                        // Clear form
                        cancelDocumentEdit();
                        loadDocuments();
                    } else {
                        showAlert('newsAlert', data.error || `Failed to add ${documentType} document`, 'error');
                    }
                }
            } catch (error) {
                showAlert('newsAlert', 'Error adding document', 'error');
                console.error('Error:', error);
            }
        }

        async function editNews(newsId, title, content, clinicalTrialId) {
            console.log('ðŸ–Šï¸ Editing news item:', newsId, title);

            // Set editing mode
            editingNewsId = newsId;

            // Make sure we're on the News & Updates tab
            showTab(1);

            // Set document type to news
            document.getElementById('documentType').value = 'news';
            toggleDocumentForm();

            // Update form title and button
            document.getElementById('documentFormTitle').textContent = 'Edit News Item';
            document.getElementById('documentSubmitBtn').textContent = 'Update News';
            document.getElementById('documentCancelBtn').style.display = 'inline-block';

            // Populate form with existing data
            document.getElementById('documentTitle').value = title;
            document.getElementById('newsContent').value = content;

            // Wait for clinical trial selector to be populated, then set the value
            setTimeout(async () => {
                // Ensure clinical trial selector is populated
                if (!clinicalTrials || clinicalTrials.length === 0) {
                    await loadClinicalTrials();
                }
                await populateNewsClinicalTrialSelector();

                // Now set the clinical trial value
                const clinicalTrialElement = document.getElementById('newsClinicalTrial');
                if (clinicalTrialElement) {
                    clinicalTrialElement.value = clinicalTrialId;
                    console.log('ðŸ“ Set clinical trial value to:', clinicalTrialId);
                } else {
                    console.error('âŒ Could not find newsClinicalTrial element to set value');
                }
            }, 500);

            console.log('ðŸ“ Form populated with:', { title, content });

            // Scroll to form
            setTimeout(() => {
                document.getElementById('documentsSection').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function cancelDocumentEdit() {
            // Reset editing state
            editingNewsId = null;

            // Reset form
            document.getElementById('documentFormTitle').textContent = 'Add News/Update or Upload Document';
            document.getElementById('documentSubmitBtn').textContent = 'Add Document';
            document.getElementById('documentCancelBtn').style.display = 'none';

            // Clear all form fields
            document.getElementById('documentType').value = 'news';
            document.getElementById('documentTitle').value = '';
            document.getElementById('newsContent').value = '';
            document.getElementById('documentDescription').value = '';
            document.getElementById('documentCategory').value = '';
            document.getElementById('documentFile').value = '';

            // Reset form display
            toggleDocumentForm();
        }

        async function deleteNews(newsId) {
            if (!confirm('Are you sure you want to delete this news item?')) return;

            try {
                const response = await fetch(`${window.API_BASE_URL}/api/news/${newsId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('newsAlert', 'News item deleted successfully!', 'success');
                    loadNewsItems(); // Refresh news data
                } else {
                    showAlert('newsAlert', data.message || 'Failed to delete news item', 'error');
                }
            } catch (error) {
                showAlert('newsAlert', 'Error deleting news item', 'error');
                console.error('Error:', error);
            }
        }

        // PDF Management Functions
        async function loadDocuments() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/documents`);
                const data = await response.json();

                if (response.ok) {
                    updateDocumentsList(data.documents || []);
                } else {
                    console.error('Failed to load documents:', data.error);
                    updateDocumentsList([]);
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                updateDocumentsList([]);
            }
        }

        function updateDocumentsList(documents) {
            const container = document.getElementById('documentItemsList');

            if (!documents || documents.length === 0) {
                container.innerHTML = '<p>No documents uploaded yet.</p>';
                return;
            }

            container.innerHTML = documents.map(doc => `
                <div class="news-item">
                    <div class="news-header">
                        <h5>${doc.title}</h5>
                        <small>${doc.category} â€¢ ${new Date(doc.uploadDate).toLocaleDateString()}</small>
                    </div>
                    <p>${doc.description}</p>
                    <div class="news-actions">
                        <button class="btn btn-sm" onclick="viewDocument('${doc.id}', '${doc.filename}', '${doc.title}', '${doc.type}')">View</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDocument('${doc.id}', '${doc.type}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function viewDocument(docId, filename, title, type) {
            if (type === 'pdf') {
                // Use existing PDF viewer
                viewPDF(docId, filename, title);
            } else {
                // For text documents, show a simple viewer
                showTextDocumentViewer(docId, filename, title);
            }
        }

        async function deleteDocument(docId, type) {
            if (!confirm(`Are you sure you want to delete this ${type} document?`)) return;

            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/documents/${docId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('newsAlert', `${type.toUpperCase()} document deleted successfully!`, 'success');
                    loadDocuments();
                } else {
                    showAlert('newsAlert', `Failed to delete ${type} document`, 'error');
                }
            } catch (error) {
                showAlert('newsAlert', `Error deleting ${type} document`, 'error');
                console.error('Error:', error);
            }
        }

        function showTextDocumentViewer(docId, filename, title) {
            // For now, just show an alert - in production you'd fetch and display the text content
            alert(`Viewing text document: ${title}\n\nFile: ${filename}\n\nDocument ID: ${docId}\n\n(Note: Full text viewer implementation would require backend file serving capabilities)`);
        }

        async function loadPDFDocuments() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/pdfs`);
                const data = await response.json();
                
                if (response.ok) {
                    updatePDFsList(data.pdfs);
                } else {
                    console.error('Failed to load PDFs:', data.error);
                }
            } catch (error) {
                console.error('Error loading PDFs:', error);
            }
        }

        function updatePDFsList(pdfs) {
            const pdfsList = document.getElementById('pdfItemsList');
            
            if (pdfs.length === 0) {
                pdfsList.innerHTML = '<p>No PDF documents found</p>';
                return;
            }

            pdfsList.innerHTML = pdfs.map(pdf => `
                <div class="pdf-item">
                    <div class="pdf-info">
                        <h5>${pdf.title}</h5>
                        <p style="color: #666; margin-bottom: 0.5rem;">${pdf.description}</p>
                        <div>
                            <span class="category-badge">${pdf.category}</span>
                            <small style="color: #999;">${pdf.filename} â€¢ ${new Date(pdf.uploadDate).toLocaleDateString()}</small>
                        </div>
                    </div>
                    <div class="pdf-actions">
                        <button class="btn btn-primary" onclick="viewPDF('${pdf.id}', '${pdf.filename}', '${pdf.title}')">View PDF</button>
                        <button class="btn btn-secondary" onclick="downloadPDF('${pdf.id}', '${pdf.filename}')">Download</button>
                        <button class="btn btn-reject" onclick="deletePDF('${pdf.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function deletePDF(pdfId) {
            if (!confirm('Are you sure you want to delete this PDF document?')) return;

            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/pdfs/${pdfId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('newsAlert', 'PDF document deleted successfully!', 'success');
                    loadPDFDocuments(); // Refresh PDFs
                } else {
                    showAlert('newsAlert', data.error || 'Failed to delete PDF', 'error');
                }
            } catch (error) {
                showAlert('newsAlert', 'Error deleting PDF document', 'error');
                console.error('Error:', error);
            }
        }

        // PDF Viewing Functions
        let currentPDFId = null;
        let currentPDFFilename = null;

        function viewPDF(pdfId, filename, title) {
            currentPDFId = pdfId;
            currentPDFFilename = filename;
            
            // Set modal title
            document.getElementById('pdfModalTitle').textContent = `Viewing: ${title}`;
            
            // Create PDF viewer URL - using Google Docs viewer as a fallback
            const pdfUrl = `${window.API_BASE_URL}/api/company/${currentCompany}/pdfs/${pdfId}/file`;
            const googleDocsUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(pdfUrl)}&embedded=true`;
            
            // Try to load the PDF directly first, fallback to Google Docs viewer
            const iframe = document.getElementById('pdfViewerFrame');
            iframe.src = pdfUrl;
            
            // Show the modal
            document.getElementById('pdfViewerModal').style.display = 'block';
            
            // Handle iframe load errors and fallback to Google Docs viewer
            iframe.onerror = function() {
                iframe.src = googleDocsUrl;
            };
        }

        function closePDFViewer() {
            document.getElementById('pdfViewerModal').style.display = 'none';
            document.getElementById('pdfViewerFrame').src = '';
            currentPDFId = null;
            currentPDFFilename = null;
        }

        async function downloadPDF(pdfId, filename) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/pdfs/${pdfId}/file`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    showAlert('newsAlert', 'Failed to download PDF', 'error');
                }
            } catch (error) {
                showAlert('newsAlert', 'Error downloading PDF', 'error');
                console.error('Error:', error);
            }
        }

        function downloadCurrentPDF() {
            if (currentPDFId && currentPDFFilename) {
                downloadPDF(currentPDFId, currentPDFFilename);
            }
        }

        // Leaderboard Functions
        async function loadLeaderboard() {
            try {
                // Temporary: Remove authentication for testing
                const response = await fetch(`${window.API_BASE_URL}/api/hospitals`, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateLeaderboard(data);
                } else {
                    updateLeaderboard({ hospitals: [], summary: { totalConsented: 0, totalRandomized: 0, totalHospitals: 0 } });
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                updateLeaderboard({ hospitals: [], summary: { totalConsented: 0, totalRandomized: 0, totalHospitals: 0 } });
            }
        }

        function updateLeaderboardTable(hospitals) {
            const tbody = document.getElementById('leaderboardTableBody');

            if (!hospitals || hospitals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No hospitals found</td></tr>';
                return;
            }

            tbody.innerHTML = hospitals.map((hospital, index) => `
                <tr data-hospital-id="${hospital.id}">
                    <td>${index + 1} ${getTrophyEmoji(index)}</td>
                    <td>${hospital.name}</td>
                    <td>${hospital.location}</td>
                    <td>${hospital.principal_investigator}</td>
                    <td>${hospital.consented_patients}</td>
                    <td>${hospital.randomized_patients}</td>
                    <td>${hospital.consent_rate}%</td>
                    <td>
                        <button onclick="editHospital('${hospital.id}')" class="btn-edit">Edit</button>
                        <button onclick="deleteHospital('${hospital.id}')" class="btn-delete">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function getTrophyEmoji(index) {
            switch (index) {
                case 0: return 'ðŸ†';
                case 1: return 'ðŸ¥ˆ';
                case 2: return 'ðŸ¥‰';
                default: return '';
            }
        }

        function updateLeaderboard(data) {
            // Update summary stats
            document.getElementById('totalConsented').textContent = data.summary.totalConsented;
            document.getElementById('totalRandomized').textContent = data.summary.totalRandomized;
            document.getElementById('totalHospitals').textContent = data.summary.totalHospitals;

            // Update leaderboard table
            const tbody = document.getElementById('leaderboardTableBody');
            
            if (data.hospitals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No hospitals found</td></tr>';
                return;
            }

            // Sort by consented patients (descending)
            const sortedHospitals = data.hospitals.sort((a, b) => b.consented_patients - a.consented_patients);

            tbody.innerHTML = sortedHospitals.map((hospital, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const medal = rank === 1 ? 'ðŸ¥‡' : rank === 2 ? 'ðŸ¥ˆ' : rank === 3 ? 'ðŸ¥‰' : rank;
                
                return `
                    <tr class="${rankClass}" data-hospital-id="${hospital.id}">
                        <td style="font-weight: bold;">${medal}</td>
                        <td>${hospital.name}</td>
                        <td>${hospital.location}</td>
                        <td>${hospital.principal_investigator}</td>
                        <td style="font-weight: bold; color: #1976d2;">${hospital.consented_patients}</td>
                        <td>${hospital.randomized_patients}</td>
                        <td>${hospital.consent_rate}%</td>
                        <td>
                            <button class="btn-edit" onclick="editHospital('${hospital.id}')">Edit</button>
                            <button class="btn-delete" onclick="deleteHospital('${hospital.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editHospital(hospitalId) {
            console.log('ðŸ“ Editing hospital:', hospitalId);
            
            // Find the table row with this hospital ID
            const row = document.querySelector(`tr[data-hospital-id="${hospitalId}"]`);
            if (!row) {
                console.error('âŒ Could not find hospital row');
                return;
            }
            
            // Extract data from the table cells
            const cells = row.querySelectorAll('td');
            const hospitalData = {
                name: cells[1].textContent,
                location: cells[2].textContent,
                principalInvestigator: cells[3].textContent,
                consentedPatients: parseInt(cells[4].textContent),
                randomizedPatients: parseInt(cells[5].textContent),
                consentRate: parseFloat(cells[6].textContent)
            };
            
            console.log('ðŸ“‹ Hospital data:', hospitalData);
            
            // Populate the form
            document.getElementById('hospitalName').value = hospitalData.name;
            document.getElementById('hospitalLocation').value = hospitalData.location;
            document.getElementById('principalInvestigator').value = hospitalData.principalInvestigator;
            document.getElementById('consentedPatients').value = hospitalData.consentedPatients;
            document.getElementById('randomizedPatients').value = hospitalData.randomizedPatients;
            document.getElementById('consentRate').value = hospitalData.consentRate;
            
            // Update form state
            editingHospitalId = hospitalId;
            document.getElementById('hospitalFormTitle').textContent = 'Edit Hospital';
            document.getElementById('saveHospitalBtn').textContent = 'Update Hospital';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            
            // Add visual feedback
            document.querySelectorAll('.leaderboard-table tr').forEach(tr => {
                if (tr.dataset.hospitalId === hospitalId) {
                    tr.classList.add('editing-row');
                } else {
                    tr.classList.add('other-rows');
                }
            });
            
            // Scroll to form
            document.querySelector('.news-form').scrollIntoView({ behavior: 'smooth' });
            
            console.log('âœ… Edit mode activated');
        }

        function cancelEdit() {
            // Clear form
            document.getElementById('hospitalName').value = '';
            document.getElementById('hospitalLocation').value = '';
            document.getElementById('principalInvestigator').value = '';
            document.getElementById('consentedPatients').value = '';
            document.getElementById('randomizedPatients').value = '';
            document.getElementById('consentRate').value = '';
            
            // Reset form state
            editingHospitalId = null;
            document.getElementById('hospitalFormTitle').textContent = 'Add New Hospital';
            document.getElementById('saveHospitalBtn').textContent = 'Add Hospital';
            document.getElementById('cancelEditBtn').style.display = 'none';
            
            // Remove visual feedback
            document.querySelectorAll('.leaderboard-table tr').forEach(tr => {
                tr.classList.remove('editing-row', 'other-rows');
            });
        }

        async function saveHospital() {
            if (!currentCompany) {
                showAlert('leaderboardAlert', 'Error: No company selected', 'error');
                return;
            }

            const hospitalData = {
                name: document.getElementById('hospitalName').value,
                location: document.getElementById('hospitalLocation').value,
                principalInvestigator: document.getElementById('principalInvestigator').value,
                consentedPatients: parseInt(document.getElementById('consentedPatients').value) || 0,
                randomizedPatients: parseInt(document.getElementById('randomizedPatients').value) || 0,
                consentRate: parseFloat(document.getElementById('consentRate').value) || 0
            };
            
            if (!hospitalData.name || !hospitalData.location || !hospitalData.principalInvestigator) {
                showAlert('leaderboardAlert', 'Please fill in all required fields', 'error');
                return;
            }

            try {

                const token = localStorage.getItem('token');
                const isEditing = editingHospitalId !== null;
                const url = isEditing
                    ? `${window.API_BASE_URL}/api/hospitals/${editingHospitalId}`
                    : '${window.API_BASE_URL}/api/hospitals';
                const method = isEditing ? 'PUT' : 'POST';


                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : '',
                    },
                    body: JSON.stringify({
                        name: hospitalData.name,
                        location: hospitalData.location,
                        principalInvestigator: hospitalData.principalInvestigator,
                        consentedPatients: hospitalData.consentedPatients,
                        randomizedPatients: hospitalData.randomizedPatients,
                        consentRate: hospitalData.consentRate
                    })
                });
                
                let data;
                try {
                    data = await response.json();
                } catch (parseError) {
                    
                    // Check if response is HTML (error page)
                    if (response.headers.get('content-type')?.includes('text/html')) {
                        console.error('âŒ Server returned HTML instead of JSON - likely a 404 or server error');
                        showAlert('leaderboardAlert', 'Server endpoint not found. Please restart the server with updated code.', 'error');
                        return;
                    }
                    
                    showAlert('leaderboardAlert', 'Invalid response from server', 'error');
                    return;
                }
                
                if (response.ok && data.success) {
                    showAlert('leaderboardAlert', `Hospital ${isEditing ? 'updated' : 'added'} successfully!`, 'success');

                    // Clear form and reload data
                    if (isEditing) {
                        cancelEdit();
                    } else {
                        document.getElementById('hospitalName').value = '';
                        document.getElementById('hospitalLocation').value = '';
                        document.getElementById('principalInvestigator').value = '';
                        document.getElementById('consentedPatients').value = '';
                        document.getElementById('randomizedPatients').value = '';
                        document.getElementById('consentRate').value = '';
                    }

                    loadLeaderboard(); // Refresh leaderboard
                } else {
                    console.error('âŒ Server error:', data.error);
                    showAlert('leaderboardAlert', data.error || 'Failed to save hospital', 'error');
                }
            } catch (error) {
                console.error('âŒ Network error:', error.message);
                showAlert('leaderboardAlert', `Network error: ${error.message}`, 'error');
            }
        }

        async function deleteHospital(hospitalId) {
            if (!confirm('Are you sure you want to delete this hospital?')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${window.API_BASE_URL}/api/hospitals/${hospitalId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showAlert('leaderboardAlert', 'Hospital deleted successfully!', 'success');
                    loadLeaderboard(); // Refresh leaderboard
                } else {
                    showAlert('leaderboardAlert', data.error || 'Failed to delete hospital', 'error');
                }
            } catch (error) {
                showAlert('leaderboardAlert', 'Error deleting hospital', 'error');
                console.error('Error:', error);
            }
        }

        // Debug Functions
        function updateDebugInfo() {
            // Update debug info (logo removed)
            const logoDebug = document.getElementById('logoDebugInfo');
            logoDebug.textContent = `
Company Info: ${JSON.stringify(companyInfo, null, 2)}
            `;

            // Update company debug info
            const companyDebug = document.getElementById('companyDebugInfo');
            companyDebug.textContent = `
Current Company: ${currentCompany}
Company Info: ${JSON.stringify(companyInfo, null, 2)}
LocalStorage: ${localStorage.getItem('companyInfo')}
            `;
        }

        async function testLogoAccess() {
            const results = document.getElementById('logoTestResults') || document.getElementById('logoDebugInfo');

            try {
                // Test logos health endpoint
                const healthResponse = await fetch('${window.API_BASE_URL}/logos-health');
                const healthData = await healthResponse.json();
                
                // Test specific logo
                const logoResponse = await fetch(`http://localhost:3000/test-logo/${currentCompany}-logo.png`);
                const logoExists = logoResponse.ok;
                
                const resultText = `
ðŸ¥ Logo Directory Health: ${healthResponse.ok ? 'âœ… OK' : 'âŒ Failed'}
ðŸ“ Logo Files Found: ${healthData.files?.length || 0}
ðŸ–¼ï¸ Current Logo Test: ${logoExists ? 'âœ… Found' : 'âŒ Not Found'}
ðŸ“‹ Available Logos: ${JSON.stringify(healthData.files || [], null, 2)}
                `;
                
                if (results.tagName === 'PRE') {
                    results.textContent = resultText;
                } else {
                    results.innerHTML = `<pre>${resultText}</pre>`;
                }
            } catch (error) {
                const errorText = `âŒ Logo test failed: ${error.message}`;
                if (results.tagName === 'PRE') {
                    results.textContent = errorText;
                } else {
                    results.innerHTML = `<pre>${errorText}</pre>`;
                }
            }
        }

        async function testServerConnectivity() {
            const results = document.getElementById('apiTestResults');

            try {
                // Test health endpoint
                const healthResponse = await fetch('${window.API_BASE_URL}/health');
                const healthData = await healthResponse.json();
                
                // Test company-specific endpoints
                const dashboardResponse = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/dashboard`);
                const dashboardOk = dashboardResponse.ok;
                
                const hospitalsResponse = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/hospitals`);
                const hospitalsOk = hospitalsResponse.ok;
                
                results.textContent = `
ðŸ¥ Server Health: ${healthResponse.ok ? 'âœ… OK' : 'âŒ Failed'}
ðŸ“Š Dashboard API: ${dashboardOk ? 'âœ… OK' : 'âŒ Failed'}
ðŸ¥ Hospitals API: ${hospitalsOk ? 'âœ… OK' : 'âŒ Failed'}
ðŸ”§ Server Info: ${JSON.stringify(healthData, null, 2)}
                `;
            } catch (error) {
                results.textContent = `âŒ Server connectivity test failed: ${error.message}`;
            }
        }

        async function testHospitalAPI() {
            const results = document.getElementById('apiTestResults');
            
            try {
                // Test GET hospitals
                const getResponse = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/hospitals`);
                const getOk = getResponse.ok;
                let getCount = 0;
                
                if (getOk) {
                    const getData = await getResponse.json();
                    getCount = getData.hospitals?.length || 0;
                }
                
                // Test POST with dummy data
                const testHospital = {
                    name: 'Test Hospital',
                    location: 'Test City',
                    principalInvestigator: 'Dr. Test',
                    consentedPatients: 1,
                    randomizedPatients: 1,
                    consentRate: 1.0
                };
                
                const postResponse = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/hospitals`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testHospital)
                });
                const postOk = postResponse.ok;
                
                // If we created a test hospital, delete it
                if (postOk) {
                    const postData = await postResponse.json();
                    if (postData.hospital?.id) {
                        await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/hospitals/${postData.hospital.id}`, {
                            method: 'DELETE'
                        });
                    }
                }
                
                results.textContent = `
ðŸ“Š GET Hospitals: ${getOk ? 'âœ… OK' : 'âŒ Failed'}
ðŸ“‹ Current Hospital Count: ${getCount}
âž• POST Hospital Test: ${postOk ? 'âœ… OK' : 'âŒ Failed'}
ðŸ—‘ï¸ Cleanup: ${postOk ? 'âœ… Test hospital removed' : 'N/A'}
                `;
            } catch (error) {
                results.textContent = `âŒ Hospital API test failed: ${error.message}`;
            }
        }

        async function testBasicEndpoint() {
            const results = document.getElementById('apiTestResults');
            
            try {
                const response = await fetch('${window.API_BASE_URL}/test');
                const data = await response.json();
                
                results.textContent = `
ðŸ” Basic Test Endpoint: ${response.ok ? 'âœ… OK' : 'âŒ Failed'}
ðŸ“‹ Response: ${JSON.stringify(data, null, 2)}
                `;
            } catch (error) {
                results.textContent = `âŒ Basic endpoint test failed: ${error.message}`;
            }
        }

        async function checkAvailableEndpoints() {
            const results = document.getElementById('apiTestResults');
            
            const endpoints = [
                '/api/backup',
                '/api/emergency-export',
                '/api/restore-data',
                '/test',
                '/health',
                `/api/company/${currentCompany}/hospitals`,
                `/api/company/${currentCompany}/leaderboard`
            ];
            
            const endpointStatus = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${window.API_BASE_URL}${endpoint}`);
                    endpointStatus.push(`${endpoint}: ${response.ok ? 'âœ…' : 'âŒ'} (${response.status})`);
                } catch (error) {
                    endpointStatus.push(`${endpoint}: âŒ (${error.message})`);
                }
            }
            
            results.textContent = `
ðŸ” Endpoint Availability Check:
${endpointStatus.join('\n')}
            `;
        }

        async function exportCurrentData() {
            const resultsDiv = document.getElementById('exportResults');

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('${window.API_BASE_URL}/api/emergency-export', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Create downloadable file
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup-${currentCompany}-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    resultsDiv.innerHTML = '<p style="color: green;">âœ… Data exported successfully! Check your downloads.</p>';
                } else {
                    console.log('âŒ Data export failed:', response.status);
                    resultsDiv.innerHTML = `<p style="color: red;">âŒ Data export failed: ${response.status}</p>`;
                }
            } catch (error) {
                console.error('âŒ Data export error:', error.message);
                resultsDiv.innerHTML = `<p style="color: red;">âŒ Data export failed: ${error.message}</p>`;
            }
        }

        function showRestoreForm() {
            document.getElementById('restoreForm').style.display = 'block';
        }

        function hideRestoreForm() {
            document.getElementById('restoreForm').style.display = 'none';
            document.getElementById('restoreDataTextarea').value = '';
        }

        async function restoreData() {
            const dataText = document.getElementById('restoreDataTextarea').value;
            const resultsDiv = document.getElementById('exportResults');
            
            if (!dataText.trim()) {
                resultsDiv.innerHTML = '<p style="color: red;">âŒ Please paste backup data first</p>';
                return;
            }
            
            try {
                // Validate JSON
                const backupData = JSON.parse(dataText);

                const token = localStorage.getItem('token');
                const response = await fetch('${window.API_BASE_URL}/api/restore-data', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: dataText
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultsDiv.innerHTML = '<p style="color: green;">âœ… Data restored successfully!</p>';
                    hideRestoreForm();
                    
                    // Refresh all data
                    setTimeout(() => {
                        loadDashboardData();
                        loadPDFDocuments();
                        loadLeaderboard();
                    }, 1000);
                } else {
                    resultsDiv.innerHTML = `<p style="color: red;">âŒ Restore failed: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('âŒ Restore error:', error);
                resultsDiv.innerHTML = `<p style="color: red;">âŒ Invalid JSON or restore failed: ${error.message}</p>`;
            }
        }

        async function exportFromLeaderboard() {
            const resultsDiv = document.getElementById('exportResults');
            
            try {
                const table = document.getElementById('leaderboardTableBody');
                const rows = table.querySelectorAll('tr[data-hospital-id]');
                
                const hospitals = [];
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        hospitals.push({
                            id: row.dataset.hospitalId,
                            name: cells[1].textContent.trim(),
                            location: cells[2].textContent.trim(),
                            principalInvestigator: cells[3].textContent.trim(),
                            consentedPatients: parseInt(cells[4].textContent) || 0,
                            randomizedPatients: parseInt(cells[5].textContent) || 0,
                            consentRate: parseFloat(cells[6].textContent) || 0
                        });
                    }
                });
                
                const exportData = {
                    exportType: 'leaderboard-client-side',
                    exportDate: new Date().toISOString(),
                    company: currentCompany,
                    hospitals: hospitals,
                    summary: {
                        totalHospitals: hospitals.length,
                        totalConsented: hospitals.reduce((sum, h) => sum + h.consentedPatients, 0),
                        totalRandomized: hospitals.reduce((sum, h) => sum + h.randomizedPatients, 0)
                    }
                };
                
                console.log('ðŸ“Š Extracted data:', exportData);
                
                // Create downloadable file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `leaderboard-backup-${currentCompany}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                resultsDiv.innerHTML = `<p style="color: green;">âœ… Found ${hospitals.length} hospitals. Data exported successfully! Check your downloads.</p>`;
            } catch (error) {
                console.error('âŒ Client-side export error:', error);
                resultsDiv.innerHTML = `<p style="color: red;">âŒ Export failed: ${error.message}</p>`;
            }
        }

        // Training Materials Functions

        function toggleTrainingUploadOptions() {
            const type = document.getElementById('trainingType').value;
            const textSection = document.getElementById('textContentSection');
            const fileSection = document.getElementById('fileUploadSection');
            
            textSection.style.display = 'none';
            fileSection.style.display = 'none';
            
            if (type === 'text') {
                textSection.style.display = 'block';
            } else if (type === 'pdf' || type === 'video') {
                fileSection.style.display = 'block';
                const fileInput = document.getElementById('trainingFile');
                if (type === 'pdf') {
                    fileInput.accept = '.pdf';
                } else if (type === 'video') {
                    fileInput.accept = '.mp4,.avi,.mov,.wmv';
                }
            }
        }

        async function loadTrainingMaterials() {
            try {
                // Ensure clinical trials are loaded for the training materials creation dropdown
                if (!clinicalTrials || clinicalTrials.length === 0) {
                    console.log('ðŸ”„ Clinical trials not loaded yet, loading them for training materials...');
                    await loadClinicalTrials();
                }

                // Temporary: Call backend API for testing
                const token = localStorage.getItem('token');
                const response = await fetch('${window.API_BASE_URL}/api/training-materials', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateTrainingMaterialsList(data.trainingMaterials);
                } else {
                    updateTrainingMaterialsList([]);
                }
            } catch (error) {
                console.error('Error loading training materials:', error);
                updateTrainingMaterialsList([]);
            }
        }

        function updateTrainingMaterialsList(materials) {
            const list = document.getElementById('trainingMaterialsList');
            
            if (materials.length === 0) {
                list.innerHTML = '<p>No training materials found.</p>';
                return;
            }
            
            list.innerHTML = materials.map(material => `
                <div class="pdf-item">
                    <div class="pdf-content">
                    <div class="pdf-info">
                        <h5>${material.title}</h5>
                        <p>${material.description}</p>
                        <small>
                            <span class="category-badge">${material.category}</span>
                            <span class="category-badge">${material.type}</span>
                            ${material.uploadDate} | Created by ${material.createdBy}
                        </small>
                        ${material.type === 'text' ? `<div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 200px; overflow-y: auto;">${material.content}</div>` : ''}
                    </div>
                        <div class="pdf-actions">
                            <button class="btn-view" onclick="viewTrainingMaterial('${material.id}')">View</button>
                            <button class="btn-download" onclick="downloadTrainingMaterial('${material.id}')">Download</button>
                            <button class="btn-edit" onclick="editTrainingMaterial('${material.id}')">Edit</button>
                    <button class="btn-delete" onclick="deleteTrainingMaterial('${material.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function editTrainingMaterial(materialId) {
            try {
                // Fetch the training material data directly
                const token = localStorage.getItem('token');
                const response = await fetch('${window.API_BASE_URL}/api/training-materials', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error('Failed to fetch training materials');
                }

                const material = data.trainingMaterials.find(m => m.id === materialId);

                if (!material) {
                    showAlert('trainingAlert', 'Training material not found', 'error');
                    return;
                }

                // Populate the form with existing data
                document.getElementById('trainingTitle').value = material.title || '';
                document.getElementById('trainingDescription').value = material.description || '';
                document.getElementById('trainingType').value = material.type || '';
                document.getElementById('trainingCategory').value = material.category || '';
                document.getElementById('trainingClinicalTrial').value = material.clinical_trial_id || '';

                // Handle content based on type
                if (material.type === 'text') {
                    document.getElementById('textContentSection').style.display = 'block';
                    document.getElementById('trainingTextContent').value = material.content || '';
                    document.getElementById('fileUploadSection').style.display = 'none';
                } else if (material.type === 'pdf' || material.type === 'video') {
                    document.getElementById('textContentSection').style.display = 'none';
                    document.getElementById('fileUploadSection').style.display = 'block';
                    // Note: File inputs can't be pre-populated for security reasons
                }

                // Update form state
                const formTitle = document.querySelector('#tab4 h3');
                if (formTitle) {
                    formTitle.textContent = 'Edit Training Material';
                }
                const submitBtn = document.getElementById('trainingSubmitBtn');
                if (submitBtn) {
                    submitBtn.textContent = 'Update Training Material';
                }
                const cancelBtn = document.getElementById('trainingCancelBtn');
                if (cancelBtn) {
                    cancelBtn.style.display = 'inline-block';
                }
                editingTrainingMaterialId = materialId;

                // Scroll to form and highlight it
                document.getElementById('trainingTitle').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('trainingTitle').focus();

                showAlert('trainingAlert', 'Edit the training material and click "Update Training Material"', 'info');
            } catch (error) {
                console.error('Error loading training material for edit:', error);
                showAlert('trainingAlert', 'Error loading training material for edit', 'error');
            }
        }

        async function addTrainingMaterial() {
            const title = document.getElementById('trainingTitle').value;
            const description = document.getElementById('trainingDescription').value;
            const type = document.getElementById('trainingType').value;
            const category = document.getElementById('trainingCategory').value;
            const clinical_trial_id = document.getElementById('trainingClinicalTrial').value;

            if (!title || !type || !clinical_trial_id) {
                showAlert('trainingAlert', 'Please fill in title, select type, and clinical trial', 'error');
                return;
            }
            
            let content = '';
            if (type === 'text') {
                content = document.getElementById('trainingTextContent').value;
                if (!content) {
                    showAlert('trainingAlert', 'Please enter text content', 'error');
                    return;
                }
            } else {
                const fileInput = type === 'pdf' ? document.getElementById('trainingFile') : document.getElementById('trainingFile');
                if (fileInput.files.length === 0) {
                    showAlert('trainingAlert', 'Please select a file to upload', 'error');
                    return;
                }
                // For demo purposes, we'll just use the filename
                content = `Uploaded file: ${fileInput.files[0].name}`;
            }
            
            try {
                console.log('Sending training material data:', { title, description, type, content, category, editingTrainingMaterialId });

                const isEditing = editingTrainingMaterialId !== null;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing
                    ? `${window.API_BASE_URL}/api/training-materials/${editingTrainingMaterialId}`
                    : '${window.API_BASE_URL}/api/training-materials';

                const token = localStorage.getItem('token');
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : '',
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        type,
                        content,
                        category,
                        clinical_trial_id: clinical_trial_id
                    })
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && data.success) {
                    showAlert('trainingAlert', `Training material ${isEditing ? 'updated' : 'added'} successfully!`, 'success');

                    // Clear form and reset edit state
                    cancelTrainingMaterialEdit();

                    // Small delay before refreshing to ensure backend processing is complete
                    setTimeout(() => {
                        loadTrainingMaterials(); // Refresh list
                    }, 500);
                } else {
                    showAlert('trainingAlert', data.message || `Failed to ${isEditing ? 'update' : 'add'} training material`, 'error');
                    console.error('Backend error:', data);
                }
            } catch (error) {
                showAlert('trainingAlert', 'Error adding training material - but data may have been saved. Please refresh to check.', 'warning');
                console.error('Frontend error:', error);
            }
        }

        function cancelTrainingMaterialEdit() {
                    // Clear form
                    document.getElementById('trainingTitle').value = '';
                    document.getElementById('trainingDescription').value = '';
                    document.getElementById('trainingType').value = '';
                    document.getElementById('trainingTextContent').value = '';
                    document.getElementById('trainingFile').value = '';
            document.getElementById('trainingCategory').value = '';
                    document.getElementById('textContentSection').style.display = 'none';
                    document.getElementById('fileUploadSection').style.display = 'none';
                    
            // Reset form state
            const formTitle = document.querySelector('#tab4 h3');
            if (formTitle) {
                formTitle.textContent = 'Training Materials';
            }
            const submitBtn = document.getElementById('trainingSubmitBtn');
            if (submitBtn) {
                submitBtn.textContent = 'Add Training Material';
            }
            const cancelBtn = document.getElementById('trainingCancelBtn');
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
            }

            // Reset editing state
            editingTrainingMaterialId = null;
        }

        async function viewTrainingMaterial(materialId) {
            try {
                // Fetch the training material data directly
                const token = localStorage.getItem('token');
                const response = await fetch('${window.API_BASE_URL}/api/training-materials', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error('Failed to fetch training materials');
                }

                const material = data.trainingMaterials.find(m => m.id === materialId);

                if (!material) {
                    showAlert('trainingAlert', 'Training material not found', 'error');
                    return;
                }

                if (material.type === 'text') {
                    // Show text content in a modal or alert
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    `;

                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        max-width: 80%;
                        max-height: 80%;
                        overflow-y: auto;
                        position: relative;
                    `;

                    modalContent.innerHTML = `
                        <h3>${material.title}</h3>
                        <div style="margin: 10px 0; color: #666;">
                            <strong>Category:</strong> ${material.category} |
                            <strong>Type:</strong> ${material.type} |
                            <strong>Created by:</strong> ${material.createdBy}
                        </div>
                        <pre style="white-space: pre-wrap; font-family: monospace; background: #f5f5f5; padding: 15px; border-radius: 4px; margin-top: 15px;">${material.content}</pre>
                        <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 15px; padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                    `;

                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);

                    // Close modal when clicking outside
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                } else if (material.type === 'pdf' || material.type === 'video') {
                    // For files, open in new tab/window for viewing
                    const fileUrl = material.content.startsWith('http') ? material.content : `data:text/plain;base64,${btoa(material.content)}`;
                    window.open(fileUrl, '_blank');
                }
            } catch (error) {
                console.error('Error viewing training material:', error);
                showAlert('trainingAlert', 'Error viewing training material', 'error');
            }
        }

        async function downloadTrainingMaterial(materialId) {
            try {
                // Fetch the training material data directly
                const token = localStorage.getItem('token');
                const response = await fetch('${window.API_BASE_URL}/api/training-materials', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error('Failed to fetch training materials');
                }

                const material = data.trainingMaterials.find(m => m.id === materialId);

                if (!material) {
                    showAlert('trainingAlert', 'Training material not found', 'error');
                    return;
                }

                if (material.type === 'text') {
                    // Download text content as a file
                    const blob = new Blob([material.content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${material.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else if (material.type === 'pdf' || material.type === 'video') {
                    // For files, trigger download
                    const link = document.createElement('a');
                    if (material.content.startsWith('http')) {
                        link.href = material.content;
                } else {
                        // Assume it's a filename or path
                        link.href = material.content;
                    }
                    link.download = material.content.split('/').pop() || `${material.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${material.type === 'pdf' ? 'pdf' : 'mp4'}`;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (error) {
                console.error('Error downloading training material:', error);
                showAlert('trainingAlert', 'Error downloading training material', 'error');
            }
        }

        async function deleteTrainingMaterial(materialId) {
            if (!confirm('Are you sure you want to delete this training material?')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${window.API_BASE_URL}/api/training-materials/${materialId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : '',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('trainingAlert', 'Training material deleted successfully!', 'success');
                    loadTrainingMaterials(); // Refresh list
                } else {
                    showAlert('trainingAlert', data.error || 'Failed to delete training material', 'error');
                }
            } catch (error) {
                showAlert('trainingAlert', 'Error deleting training material', 'error');
                console.error('Error:', error);
            }
        }

        // Study Protocol Functions

        function toggleProtocolUploadOptions() {
            const type = document.getElementById('protocolType').value;
            const textSection = document.getElementById('protocolTextContentSection');
            const fileSection = document.getElementById('protocolFileUploadSection');
            
            textSection.style.display = 'none';
            fileSection.style.display = 'none';
            
            if (type === 'text') {
                textSection.style.display = 'block';
            } else if (type === 'pdf') {
                fileSection.style.display = 'block';
            }
        }

        async function loadStudyProtocols() {
            try {
                // Ensure clinical trials are loaded for the study protocols creation dropdown
                if (!clinicalTrials || clinicalTrials.length === 0) {
                    console.log('ðŸ”„ Clinical trials not loaded yet, loading them for study protocols...');
                    await loadClinicalTrials();
                }

                // Temporary: Call backend API for testing
                const token = localStorage.getItem('token');
                const response = await fetch('${window.API_BASE_URL}/api/study-protocols', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateStudyProtocolsList(data.studyProtocols);
                } else {
                    updateStudyProtocolsList([]);
                }
            } catch (error) {
                console.error('Error loading study protocols:', error);
                updateStudyProtocolsList([]);
            }
        }

        function updateStudyProtocolsList(protocols) {
            const list = document.getElementById('studyProtocolsList');
            
            if (protocols.length === 0) {
                list.innerHTML = '<p>No study protocols found.</p>';
                return;
            }
            
            list.innerHTML = protocols.map(protocol => `
                <div class="pdf-item">
                    <div class="pdf-content">
                    <div class="pdf-info">
                        <h5>${protocol.title} <span style="color: #666; font-size: 0.8em;">v${protocol.version}</span></h5>
                        <p>${protocol.description}</p>
                        <small>
                            <span class="category-badge">${protocol.type}</span>
                            ${protocol.uploadDate} | Created by ${protocol.createdBy}
                        </small>
                        ${protocol.type === 'text' ? `<div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto;">${protocol.content}</div>` : ''}
                    </div>
                        <div class="pdf-actions">
                            <button class="btn-view" onclick="viewStudyProtocol('${protocol.id}')">View</button>
                            <button class="btn-download" onclick="downloadStudyProtocol('${protocol.id}')">Download</button>
                            <button class="btn-edit" onclick="editStudyProtocol('${protocol.id}', '${protocol.clinical_trial_id}')">Edit</button>
                    <button class="btn-delete" onclick="deleteStudyProtocol('${protocol.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function editStudyProtocol(protocolId, clinicalTrialId) {
            try {
                // Fetch the study protocol data directly
                const token = localStorage.getItem('token');
                const response = await fetch('${window.API_BASE_URL}/api/study-protocols', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error('Failed to fetch study protocols');
                }

                const protocol = data.studyProtocols.find(p => p.id === protocolId);

                if (!protocol) {
                    showAlert('protocolAlert', 'Study protocol not found', 'error');
                    return;
                }

                // Populate the form with existing data
                document.getElementById('protocolTitle').value = protocol.title || '';
                document.getElementById('protocolDescription').value = protocol.description || '';
                document.getElementById('protocolType').value = protocol.type || '';
                document.getElementById('protocolVersion').value = protocol.version || '';
                document.getElementById('protocolClinicalTrial').value = clinicalTrialId || '';

                // Handle content based on type
                if (protocol.type === 'text') {
                    document.getElementById('protocolTextContentSection').style.display = 'block';
                    document.getElementById('protocolTextContent').value = protocol.content || '';
                    document.getElementById('protocolFileUploadSection').style.display = 'none';
                } else if (protocol.type === 'pdf') {
                    document.getElementById('protocolTextContentSection').style.display = 'none';
                    document.getElementById('protocolFileUploadSection').style.display = 'block';
                    // Note: File inputs can't be pre-populated for security reasons
                }

                // Update form state
                const formTitle = document.querySelector('#tab5 h3');
                if (formTitle) {
                    formTitle.textContent = 'Edit Study Protocol';
                }
                const submitBtn = document.getElementById('protocolSubmitBtn');
                if (submitBtn) {
                    submitBtn.textContent = 'Update Study Protocol';
                }
                const cancelBtn = document.getElementById('protocolCancelBtn');
                if (cancelBtn) {
                    cancelBtn.style.display = 'inline-block';
                }
                editingStudyProtocolId = protocolId;

                // Scroll to form and highlight it
                document.getElementById('protocolTitle').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('protocolTitle').focus();

                showAlert('protocolAlert', 'Edit the study protocol and click "Update Study Protocol"', 'info');
            } catch (error) {
                console.error('Error loading study protocol for edit:', error);
                showAlert('protocolAlert', 'Error loading study protocol for edit', 'error');
            }
        }

        async function addStudyProtocol() {
            const token = localStorage.getItem('token');
            const title = document.getElementById('protocolTitle').value;
            const description = document.getElementById('protocolDescription').value;
            const type = document.getElementById('protocolType').value;
            const version = document.getElementById('protocolVersion').value;
            const clinical_trial_id = document.getElementById('protocolClinicalTrial').value;

            if (!title || !type || !clinical_trial_id) {
                showAlert('protocolAlert', 'Please fill in title, select type, and clinical trial', 'error');
                return;
            }
            
            let content = '';
            if (type === 'text') {
                content = document.getElementById('protocolTextContent').value;
                if (!content) {
                    showAlert('protocolAlert', 'Please enter protocol content', 'error');
                    return;
                }
            } else {
                const fileInput = document.getElementById('protocolFile');
                if (fileInput.files.length === 0) {
                    showAlert('protocolAlert', 'Please select a PDF file to upload', 'error');
                    return;
                }

                // First upload the file to storage
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('bucket', 'study-protocols');
                formData.append('clinical_trial_id', clinical_trial_id);

                try {
                    console.log('ðŸ“¤ Uploading file to storage...');
                    const uploadResponse = await fetch('${window.API_BASE_URL}/api/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': token ? `Bearer ${token}` : '',
                        },
                        body: formData
                    });

                    const uploadData = await uploadResponse.json();

                    if (!uploadResponse.ok || !uploadData.success) {
                        showAlert('protocolAlert', uploadData.message || 'Failed to upload file', 'error');
                        return;
                    }

                    // Use the storage path from the upload response
                    content = uploadData.data.filename;
                    console.log('âœ… File uploaded successfully:', content);

                } catch (uploadError) {
                    console.error('Upload error:', uploadError);
                    showAlert('protocolAlert', 'Failed to upload file. Please try again.', 'error');
                    return;
                }
            }
            
            try {
                console.log('Sending study protocol data:', { title, description, type, content, version, editingStudyProtocolId });

                const isEditing = editingStudyProtocolId !== null;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing
                    ? `${window.API_BASE_URL}/api/study-protocols/${editingStudyProtocolId}`
                    : '${window.API_BASE_URL}/api/study-protocols';

                const token = localStorage.getItem('token');
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : '',
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        type,
                        content,
                        version,
                        clinical_trial_id: clinical_trial_id
                    })
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && data.success) {
                    showAlert('protocolAlert', `Study protocol ${isEditing ? 'updated' : 'added'} successfully!`, 'success');

                    // Clear form and reset edit state
                    cancelStudyProtocolEdit();

                    // Small delay before refreshing to ensure backend processing is complete
                    setTimeout(() => {
                        loadStudyProtocols(); // Refresh list
                    }, 500);
                } else {
                    showAlert('protocolAlert', data.message || `Failed to ${isEditing ? 'update' : 'add'} study protocol`, 'error');
                    console.error('Backend error:', data);
                }
            } catch (error) {
                showAlert('protocolAlert', 'Error adding study protocol - but data may have been saved. Please refresh to check.', 'warning');
                console.error('Frontend error:', error);
            }
        }

        function cancelStudyProtocolEdit() {
                    // Clear form
                    document.getElementById('protocolTitle').value = '';
                    document.getElementById('protocolDescription').value = '';
                    document.getElementById('protocolType').value = '';
                    document.getElementById('protocolVersion').value = '1.0';
                    document.getElementById('protocolTextContent').value = '';
                    document.getElementById('protocolFile').value = '';
                    document.getElementById('protocolTextContentSection').style.display = 'none';
                    document.getElementById('protocolFileUploadSection').style.display = 'none';

                    // Reset file upload area
                    const selectedFileDiv = document.getElementById('protocolSelectedFile');
                    if (selectedFileDiv) {
                        selectedFileDiv.style.display = 'none';
                    }
                    const uploadText = document.querySelector('#protocolFileDropArea .upload-text');
                    if (uploadText) {
                        uploadText.innerHTML = '<strong>Drop your PDF here</strong><br>or <span class="upload-link">click to browse</span>';
                    }
                    
            // Reset form state
            const formTitle = document.querySelector('#tab5 h3');
            if (formTitle) {
                formTitle.textContent = 'Study Protocol';
            }
            const submitBtn = document.getElementById('protocolSubmitBtn');
            if (submitBtn) {
                submitBtn.textContent = 'Add Study Protocol';
            }
            const cancelBtn = document.getElementById('protocolCancelBtn');
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
            }

            // Reset editing state
            editingStudyProtocolId = null;
        }

        async function viewStudyProtocol(protocolId) {
            try {
                // Fetch the study protocol data directly
                const response = await fetch('${window.API_BASE_URL}/api/study-protocols', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error('Failed to fetch study protocols');
                }

                const protocol = data.studyProtocols.find(p => p.id === protocolId);

                if (!protocol) {
                    showAlert('protocolAlert', 'Study protocol not found', 'error');
                    return;
                }

                if (protocol.type === 'text') {
                    // Show text content in a modal
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    `;

                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        max-width: 80%;
                        max-height: 80%;
                        overflow-y: auto;
                        position: relative;
                    `;

                    modalContent.innerHTML = `
                        <h3>${protocol.title} <span style="color: #666; font-size: 0.8em;">v${protocol.version}</span></h3>
                        <div style="margin: 10px 0; color: #666;">
                            <strong>Type:</strong> ${protocol.type} |
                            <strong>Created by:</strong> ${protocol.createdBy}
                        </div>
                        <pre style="white-space: pre-wrap; font-family: monospace; background: #f5f5f5; padding: 15px; border-radius: 4px; margin-top: 15px;">${protocol.content}</pre>
                        <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 15px; padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                    `;

                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);

                    // Close modal when clicking outside
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                } else if (protocol.type === 'pdf') {
                    // For PDF files stored in Supabase storage, get signed URL
                    try {
                        const token = localStorage.getItem('token');
                        const signedUrlResponse = await fetch(`${window.API_BASE_URL}/api/files/signed-url?bucket=study-protocols&path=${encodeURIComponent(protocol.content)}`, {
                            headers: {
                                'Authorization': token ? `Bearer ${token}` : ''
                            }
                        });

                        const signedUrlData = await signedUrlResponse.json();

                        if (signedUrlResponse.ok && signedUrlData.success) {
                            window.open(signedUrlData.signedUrl, '_blank');
                        } else {
                            showAlert('protocolAlert', 'Failed to access PDF file', 'error');
                        }
                    } catch (error) {
                        console.error('Error getting signed URL:', error);
                        showAlert('protocolAlert', 'Error accessing PDF file', 'error');
                    }
                }
            } catch (error) {
                console.error('Error viewing study protocol:', error);
                showAlert('protocolAlert', 'Error viewing study protocol', 'error');
            }
        }

        async function downloadStudyProtocol(protocolId) {
            try {
                // Fetch the study protocol data directly
                const response = await fetch('${window.API_BASE_URL}/api/study-protocols', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error('Failed to fetch study protocols');
                }

                const protocol = data.studyProtocols.find(p => p.id === protocolId);

                if (!protocol) {
                    showAlert('protocolAlert', 'Study protocol not found', 'error');
                    return;
                }

                if (protocol.type === 'text') {
                    // Download text content as a file
                    const blob = new Blob([protocol.content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${protocol.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_v${protocol.version}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else if (protocol.type === 'pdf') {
                    // For PDF files stored in Supabase storage, get signed URL for download
                    try {
                        const token = localStorage.getItem('token');
                        const signedUrlResponse = await fetch(`${window.API_BASE_URL}/api/files/signed-url?bucket=study-protocols&path=${encodeURIComponent(protocol.content)}`, {
                            headers: {
                                'Authorization': token ? `Bearer ${token}` : ''
                            }
                        });

                        const signedUrlData = await signedUrlResponse.json();

                        if (signedUrlResponse.ok && signedUrlData.success) {
                            const link = document.createElement('a');
                            link.href = signedUrlData.signedUrl;
                            link.download = protocol.content.split('/').pop() || `${protocol.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_v${protocol.version}.pdf`;
                            link.target = '_blank';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        } else {
                            showAlert('protocolAlert', 'Failed to download PDF file', 'error');
                        }
                    } catch (error) {
                        console.error('Error getting signed URL for download:', error);
                        showAlert('protocolAlert', 'Error downloading PDF file', 'error');
                    }
                }
            } catch (error) {
                console.error('Error downloading study protocol:', error);
                showAlert('protocolAlert', 'Error downloading study protocol', 'error');
            }
        }

        async function deleteStudyProtocol(protocolId) {
            if (!confirm('Are you sure you want to delete this study protocol?')) return;

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${window.API_BASE_URL}/api/study-protocols/${protocolId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('protocolAlert', 'Study protocol deleted successfully!', 'success');
                    loadStudyProtocols(); // Refresh list
                } else {
                    showAlert('protocolAlert', data.error || 'Failed to delete study protocol', 'error');
                }
            } catch (error) {
                showAlert('protocolAlert', 'Error deleting study protocol', 'error');
                console.error('Error:', error);
            }
        }

        function showAlert(alertId, message, type) {
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function logout() {
            localStorage.removeItem('companyInfo');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        async function loadAnalytics() {
            try {
                // Temporary: Call backend API for testing
                const response = await fetch('${window.API_BASE_URL}/api/analytics', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (!response.ok || !data.success) throw new Error('Failed to load analytics');
                
                // Process analytics data
                const analytics = data.analytics;
                const now = new Date();
                const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                
                // Calculate summary statistics
                const totalAppOpens = analytics.reduce((sum, user) => sum + user.analytics.totalAppOpens, 0);
                const activeUsersCount = analytics.filter(user => {
                    const lastOpen = user.analytics.lastAppOpen ? new Date(user.analytics.lastAppOpen) : null;
                    return lastOpen && lastOpen > sevenDaysAgo;
                }).length;
                
                // Update summary cards
                document.getElementById('totalAppOpens').textContent = totalAppOpens;
                document.getElementById('activeUsers').textContent = activeUsersCount;
                
                // Update table
                const tableBody = document.getElementById('analyticsTableBody');
                tableBody.innerHTML = analytics.map(user => {
                    const lastActive = user.analytics.lastAppOpen 
                        ? new Date(user.analytics.lastAppOpen).toLocaleDateString()
                        : 'Never';
                    
                    // Find most viewed tab
                    const tabViews = user.analytics.tabViews;
                    const mostViewedTab = Object.entries(tabViews)
                        .sort((a, b) => b[1] - a[1])[0];
                    const mostViewedTabName = mostViewedTab ? formatTabName(mostViewedTab[0]) : 'None';
                    
                    return `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.site}</td>
                            <td>${lastActive}</td>
                            <td>${user.analytics.totalAppOpens}</td>
                            <td>${mostViewedTabName}</td>
                            <td>
                                <button onclick="showUserAnalytics('${user.id}')" class="btn-small">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Failed to load analytics:', error);
                // Show error message to user
            }
        }

        function formatTabName(tabName) {
            return tabName
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase());
        }

        async function showUserAnalytics(userId) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company/${currentCompany}/analytics`);
                const data = await response.json();
                
                const user = data.analytics.find(u => u.id === userId);
                if (!user) throw new Error('User not found');
                
                const modal = document.getElementById('userAnalyticsModal');
                const details = document.getElementById('userAnalyticsDetails');
                
                // Create detailed analytics view
                details.innerHTML = `
                    <h5>${user.name}</h5>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Site:</strong> ${user.site}</p>
                    <p><strong>Last Active:</strong> ${user.analytics.lastAppOpen ? new Date(user.analytics.lastAppOpen).toLocaleString() : 'Never'}</p>
                    <p><strong>Total App Opens:</strong> ${user.analytics.totalAppOpens}</p>
                    
                    <h6>Tab Views</h6>
                    <div class="user-analytics-chart" id="tabViewsChart_${userId}"></div>
                    
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Tab</th>
                                <th>Views</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(user.analytics.tabViews)
                                .map(([tab, views]) => `
                                    <tr>
                                        <td>${formatTabName(tab)}</td>
                                        <td>${views}</td>
                                    </tr>
                                `).join('')}
                        </tbody>
                    </table>
                `;
                
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Failed to load user analytics:', error);
                // Show error message to user
            }
        }

        function filterAnalytics() {
            const filter = document.getElementById('analyticsFilter').value;
            // Implement filtering logic
        }

        // Load analytics when tab is shown
        document.querySelector('.tab-button[onclick="showTab(5)"]').addEventListener('click', loadAnalytics);

        // Messaging Functions
        let currentConversation = null;
        let conversations = [];
        let messages = [];

        async function loadMessages() {
            try {
                // Load conversations (users who have sent/received messages)
                const conversationsResponse = await fetch(`${window.API_BASE_URL}/api/messages/conversations`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (conversationsResponse.ok) {
                    conversations = await conversationsResponse.json();
                    renderConversations();
                } else {
                    console.error('Failed to load conversations');
                    document.getElementById('conversationsList').innerHTML = '<div class="error">Failed to load conversations</div>';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('conversationsList').innerHTML = '<div class="error">Error loading conversations</div>';
            }
        }

        function renderConversations() {
            const conversationsList = document.getElementById('conversationsList');

            if (conversations.length === 0) {
                conversationsList.innerHTML = '<div class="no-conversations">No conversations yet</div>';
                return;
            }

            conversationsList.innerHTML = conversations.map(conv => `
                <div class="conversation-item ${currentConversation && currentConversation.id === conv.id ? 'active' : ''}"
                     onclick="selectConversation('${conv.id}', '${conv.name}', '${conv.lastMessage || ''}')">
                    <div class="conversation-name">${conv.name}</div>
                    <div class="conversation-preview">${conv.lastMessage || 'No messages yet'}</div>
                    <div class="conversation-time">${conv.lastMessageTime ? new Date(conv.lastMessageTime).toLocaleDateString() : ''}</div>
                </div>
            `).join('');
        }

        function selectConversation(conversationId, name, lastMessage) {
            currentConversation = { id: conversationId, name: name };
            loadConversationMessages(conversationId);
        }

        async function loadConversationMessages(conversationId) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/messages/${conversationId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    messages = await response.json();
                    renderMessages();
                } else {
                    console.error('Failed to load messages');
                }
            } catch (error) {
                console.error('Error loading conversation messages:', error);
            }
        }

        function renderMessages() {
            const messageThread = document.getElementById('messageThread');

            if (messages.length === 0) {
                messageThread.innerHTML = `
                    <div class="no-conversation">
                        <div class="no-conversation-icon">ðŸ’¬</div>
                        <h4>${currentConversation.name}</h4>
                        <p>No messages in this conversation yet</p>
                        <button class="btn-primary" onclick="composeMessage('${currentConversation.id}', '${currentConversation.name}')">Send First Message</button>
                    </div>
                `;
                return;
            }

            messageThread.innerHTML = messages.map(msg => `
                <div class="message ${msg.sender_id === localStorage.getItem('user') ? 'sent' : 'received'}">
                    <div class="message-avatar">${msg.sender_id.charAt(0).toUpperCase()}</div>
                    <div class="message-content">
                        <p class="message-text">${msg.content}</p>
                        <div class="message-time">${new Date(msg.created_at).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            messageThread.scrollTop = messageThread.scrollHeight;
        }

        function composeNewMessage() {
            // Show recipient selection modal
            const modal = document.createElement('div');
            modal.className = 'new-message-overlay';
            modal.innerHTML = `
                <div class="new-message-modal">
                    <h3>New Message</h3>
                    <select id="recipientSelect" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Select recipient...</option>
                        ${conversations.map(conv => `<option value="${conv.id}">${conv.name}</option>`).join('')}
                    </select>
                    <textarea id="newMessageText" placeholder="Type your message..." rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 1rem;"></textarea>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button onclick="this.closest('.new-message-overlay').remove()">Cancel</button>
                        <button class="btn-primary" onclick="sendNewMessage()">Send</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function sendNewMessage() {
            const recipientId = document.getElementById('recipientSelect').value;
            const messageText = document.getElementById('newMessageText').value.trim();

            if (!recipientId || !messageText) {
                alert('Please select a recipient and enter a message');
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE_URL}/api/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        recipient_id: recipientId,
                        message: messageText
                    })
                });

                if (response.ok) {
                    // Close modal and refresh
                    document.querySelector('.new-message-overlay').remove();
                    loadMessages();
                } else {
                    alert('Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message');
            }
        }

        function composeMessage(conversationId, recipientName) {
            document.getElementById('composeRecipient').textContent = `To: ${recipientName}`;
            document.getElementById('messageCompose').style.display = 'block';
            document.getElementById('messageThread').style.display = 'none';
            document.getElementById('messageInput').focus();
        }

        function cancelCompose() {
            document.getElementById('messageCompose').style.display = 'none';
            document.getElementById('messageThread').style.display = 'flex';
            document.getElementById('messageInput').value = '';
        }

        async function sendMessage() {
            const messageText = document.getElementById('messageInput').value.trim();

            if (!messageText || !currentConversation) {
                alert('Please enter a message');
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE_URL}/api/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        recipient_id: currentConversation.id,
                        message: messageText
                    })
                });

                if (response.ok) {
                    document.getElementById('messageInput').value = '';
                    loadConversationMessages(currentConversation.id);
                    loadMessages(); // Refresh conversations list
                } else {
                    alert('Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message');
            }
        }
    </script>
</body>
</html>